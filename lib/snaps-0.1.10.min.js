define("sprites/spritedef",[],function(){function b(a,d,b){this.seq=a;this.dur=d;this.def=b}function a(a,d,b,g,h){this.states={};this.image=a;this.w=d;this.h=b;this.x=g;this.y=h}b.prototype.jogPos=function(a,d){var b;b=(d-a)%this.dur;return b/this.dur};b.prototype.draw=function(a,d,b,g,h){var f=this.def,g=this.seq[Math.floor(this.seq.length*this.jogPos(g,h))];a.drawImage(f.image,g[0],g[1],f.w,f.h,d,b,f.w,f.h)};a.prototype.addState=function(a,d,i){for(var g=[],h=Math.floor(this.image.width/this.w),
f=0;f<d.length;f++){var k=d[f];g.push([this.w*(k%h),this.h*Math.floor(k/h)])}this.states[a]=new b(g,i,this)};return a});
define("sprites/sprite",[],function(){function b(a,c,d,b,g,h,f,k,s){this.def=c;this.sn=a;this.x=d;this.y=b;this.h=g;this.state=null;this.active=!0;void 0===h&&(h=0);this.maxloops=h;this.updates=f;this.endCallback=s}b.prototype.init=function(){if(void 0!==this.updates)for(var a=0;a<this.updates.length;a++)this.updates[a].init.call(this)};b.prototype.isActive=function(a){this.active&&(0<this.maxloops&&this.state.dur*this.maxloops<=a-this.epoch)&&(this.active=!1,void 0!==this.endCallback&&this.endCallback());
return this.active};b.prototype.setState=function(a,c){if(!(this.stateName===a&&this.stateExt===c)){this.stateName=a;this.stateExt=c;void 0!==c&&this.def.states.hasOwnProperty(a+"_"+c)&&(a=a+"_"+c);if(!this.def.states.hasOwnProperty(a))throw"Bad sprite definition. Missing state: "+a;this.state=this.def.states[a];this.epoch=this.sn.getNow()}};b.prototype.stateName=function(){return this.stateName};b.prototype.hasState=function(a){return this.def.states.hasOwnProperty(a)};b.prototype.morphState=function(){};
b.prototype.update=function(){if(void 0!==this.updates)for(var a=0;a<this.updates.length&&this.updates[a].fn.call(this);a++);};b.prototype.drawAt=function(a,c,d,b){this.active&&this.state.draw(a,c,d,this.epoch,b)};b.prototype.moveTo=function(a,c,d){var b=a-this.x,g=c-this.y;this.x=a;this.y=c;this.directionx=this.x+b;this.directiony=this.y+g;void 0!==d&&(this.h=d)};b.prototype.setDirection=function(a,c){this.directionx=a;this.directiony=c};b.prototype.draw=function(a,c,d,b){this.drawAt(a,this.x-c-
this.def.x,this.y-d-this.def.y-this.h,b)};return b});
define("input/keyboard",[],function(){return function(){var b=this;this.keymap={backspace:8,tab:9,enter:13,pause:19,capsLock:20,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,plus:187,comma:188,minus:189,period:190,shift:16,ctrl:17,alt:18,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,
num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,substract:109,decimal:110,divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};this.actions=[];this.keys=[];this.bind=function(a,c){b.actions[c]=0;b.keys[b.keymap[a]]=c};this.actionPressed=function(a){return!!b.actions[a]};window.addEventListener("keydown",function(a){var c=a.target.tagName;"keydown"!==a.type||("INPUT"===c||"TEXTAREA"===c)||(a.preventDefault(),
a=a.keyCode,(c=b.keys[a])&&(b.actions[c]=a))},!1);window.addEventListener("keyup",function(a){"keyup"===a.type&&(a.preventDefault(),(a=b.keys[a.keyCode])&&(b.actions[a]=0))},!1)}});define("input/mouse",[],function(){return function(b){var a=this;this.y=this.x=0;this.inputmap={mouse1:-1,mouse2:-3,wheelUp:-4,wheelDown:-5};b.addEventListener("mousemove",function(c){var d=b.getBoundingClientRect();a.x=c.clientX-d.left;a.y=c.clientY-d.top},!1)}});
define("util/preload",[],function(){function b(){this.batch=[];this.errorstate=!1}b.prototype.add=function(a,c,d){this.batch.push({file:a,tag:c,fnStore:d})};b.prototype.load=function(a,c,d){function b(d,k){return function(){f.errorstate||(h--,d.fnStore(k,d.tag),c(1-h/f.batch.length),0===h&&a())}}function g(){f.errorstate||(f.errorstate=!0,d())}var h=this.batch.length,f=this;c(0);for(var k=0;k<this.batch.length;k++){var s=this.batch[k],j=new Image;j.onload=b(s,j);j.onerror=g;j.src=s.file}};return b});
define("util/rnd",[],function(){var b=function(a,c){return a+Math.random()*(c-a+1)|0};return{rnd:b,fastRand:function(a,c){for(var d=[],i=1E4;0<i;i--)d.push(b(a,c));var g=0;return function(){g++;g===d.length&&(g=0);return d[g]}}}});
define("util/bitmap",[],function(){return{imageToRData:function(b){var a=b.width,c=b.height,d=document.createElement("canvas");d.height=c;d.width=a;d=d.getContext("2d");d.drawImage(b,0,0);b=d.getImageData(0,0,a,c).data;a=Array(b.length/4);for(c=0;c<a.length;c++)a[c]=b[4*c];return a}}});
define("util/debug",[],function(){return{debugText:function(b,a,c,d){b.fillStyle="black";b.font="bold 16px Arial";b.fillText(a,c+1,d);b.fillText(a,c-1,d);b.fillText(a,c,d+1);b.fillText(a,c,d-1);b.fillStyle="white";b.fillText(a,c,d)}}});
define("util/js",[],function(){HTMLCanvasElement.prototype.relCoords=function(b,a,c){var d=this.getBoundingClientRect();c[0]=b-d.left-window.pageXOffset;c[1]=a-d.top-window.pageYOffset};return{copyProps:function(b,a){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}}});define("util/url",[],function(){return{queryStringValue:function(b){return(b=RegExp("[?&]"+b+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(b[1].replace(/\+/g," "))}}});
define("util/all","util/preload util/rnd util/bitmap util/debug util/js util/url".split(" "),function(b,a,c,d,i,g){return{Preloader:b,rnd:a,js:i,debug:d,Bitmap:c,Url:g}});
define("map/tile",[],function(){function b(a,c,d,b,g,h,f,k,s){this.img=a;this.x=c;this.y=d;this.w=b;this.h=g;this.xoverdraw=h;this.yoverdraw=f;this.defaultProps=k||{};this.properties=s||{}}b.prototype.draw=function(a,c,d){a.drawImage(this.img,this.x,this.y,this.w,this.h,c-this.xoverdraw,d-this.yoverdraw,this.w,this.h)};b.prototype.getProperty=function(a){if(this.properties.hasOwnProperty(a))return this.properties[a];if(this.defaultProps.hasOwnProperty(a))return this.defaultProps[a]};return b});
define("map/staggered-isometric",["map/tile","util/bitmap","util/debug","util/js"],function(b,a,c){function d(a,d,c,b){this.data=a;this.hitTests=d;this.maxYOverdraw=this.maxXOverdraw=0;this.clientWidth=c;this.clientHeight=b;this.minxoffset=this.data.tilewidth/2;this.minyoffset=this.data.tileheight/2;this.maxxoffset=this.data.width*this.data.tilewidth-this.clientWidth;this.maxyoffset=this.data.height*(this.data.tileheight/2)-this.clientHeight;this.xoffset=this.minxoffset;this.yoffset=this.maxyoffset}
var i=c.debugText,g=[0,0];d.prototype.minOffsets=function(){return{minxoffset:this.data.tilewidth/2,minyoffset:this.data.tileheight/2,maxxoffset:this.data.width*this.data.tilewidth-this.clientWidth,maxyoffset:this.data.height*(this.data.tileheight/2)-this.clientHeight}};d.prototype.primePreloader=function(d){for(var c=this.data,b=this,j=function(a,c){c.image=a},g=0;g<c.tilesets.length;g++){var i=c.tilesets[g];d.add(i.image,i,j)}var j=function(d,f){if(d.width!==c.tilewidth||d.height!==c.tileheight)throw"Hit test image "+
f+" does not match map tile size";"hit"===f&&(b.hitTest=a.imageToRData(d))},h;for(h in this.hitTests)d.add(this.hitTests[h],h,j)};var h=function(a){if(void 0===a)return a;for(var d in a)"height"===d&&"string"===typeof a[d]&&(a[d]=parseInt(a[d],10));return a};d.prototype.resolveTiles=function(){var a,d,c,j,g,i=this.data;for(c=i.tilesets.length-1;0<=c;c--)j=i.tilesets[c],j.xspan=Math.floor(j.imagewidth/j.tilewidth),j.yspan=Math.floor(j.imageheight/j.tileheight);for(a=0;a<i.layers.length;a++){var l=
i.layers[a];l.rows=[];var e=[];for(d=0;d<l.data.length;d++){var m=l.data[d];if(0===m)e.push(null);else{for(c=i.tilesets.length-1;0<=c&&!(j=i.tilesets[c],j.firstgid<=m);c--);c=m-j.firstgid;var m=Math.floor(c/j.xspan),n=c-j.xspan*m;g=j.tileheight-i.tileheight;this.maxXOverdraw=Math.max(j.tilewidth-i.tilewidth,this.maxXOverdraw);this.maxYOverdraw=Math.max(g,this.maxYOverdraw);g=void 0;void 0!==j.tileproperties&&j.tileproperties.hasOwnProperty(c)&&(g=j.tileproperties[c]);e.push(new b(j.image,n*j.tilewidth,
m*j.tileheight,j.tilewidth,j.tileheight,j.tilewidth-i.tilewidth,j.tileheight-i.tileheight,h(j.properties),h(g)))}e.length>=l.width&&(l.rows.push(e),e=[])}}};d.prototype.drawDebugRegions=function(a){var c=this.data,d,b,g,h,l,e,m=c.tilewidth,n=c.tileheight/2;l=Math.floor((this.yoffset-n)/n);b=Math.floor((this.yoffset+this.clientHeight-n+this.maxYOverdraw)/n)+1;g=Math.floor((this.xoffset+this.clientWidth-1)/m);e=Math.floor((this.xoffset-m/2-this.maxXOverdraw)/m);d=c.layers[0];d=Math.min(b,d.rows.length-
1);for(b=Math.max(e,0);l<=d;l++){var u;l&1?(e=c.tilewidth/2,u="#f00"):(e=0,u="#0f0");for(h=g;h>=b;h--){a.strokeStyle=u;var q=Math.floor(-this.xoffset)+e+h*m,p=Math.floor(-this.yoffset)+l*n,r=c.tilewidth,w=c.tileheight;a.strokeRect(q,p,r,w);a.strokeStyle="#aaa";a.beginPath();a.moveTo(q,p+w/2);a.lineTo(q+r/2,p);a.lineTo(q+r,p+w/2);a.lineTo(q+r/2,p+w);a.closePath();a.stroke()}}d=c.layers[0];for(l=0;l<d.rows.length;l++){g=d.rows[l];e=l&1?c.tilewidth/2:0;for(h=g.length-1;0<=h;h--)i(a,h+","+l,85+Math.floor(-this.xoffset)+
e+h*m,55+Math.floor(-this.yoffset)+l*n)}};d.prototype.scroll=function(a,c){this.xoffset+=a;this.yoffset+=c;this.xoffset<this.minxoffset?this.xoffset=this.minxoffset:this.xoffset>this.maxxoffset&&(this.xoffset=this.maxxoffset);this.yoffset<this.minyoffset?this.yoffset=this.minyoffset:this.yoffset>this.maxyoffset&&(this.yoffset=this.maxyoffset)};d.prototype.getScreenEdges=function(){return{le:this.minxoffset,te:this.minyoffset,re:this.maxxoffset+this.clientWidth,be:this.maxyoffset+this.clientHeight}};
d.prototype.worldToTilePos=function(a,c,d){var b=this.data,g=b.tilewidth,b=b.tileheight;255!==this.hitTest[Math.floor(a%g)+Math.floor(c%b)*g]?(d[0]=Math.floor((a+g)/g)-1,d[1]=2*(Math.floor((c+b)/b)-1)):(d[0]=Math.floor((a+g/2)/g)-1,d[1]=2*Math.floor((c+b/2)/b)-1)};d.prototype.getTilePropAtWorldPos=function(a,c,d){this.worldToTilePos(c,d,g);for(var c=this.data.layers,b,d=c.length-1;0<=d;d--)if(b=c[d].rows,void 0!==b&&(0<=g[1]&&g[1]<b.length)&&(b=b[g[1]][g[0]]))if(b=b.getProperty(a),void 0!==b)return b};
d.prototype.screenToTilePos=function(a,c,d){this.worldToTilePos(a+this.xoffset,c+this.yoffset,d)};d.prototype.screenToWorldPos=function(a,c,d){d[0]=a+this.xoffset;d[1]=c+this.yoffset};d.prototype.worldToScreenPos=function(a,c,d){d[0]=a-this.xoffset;d[1]=c-this.yoffset};d.prototype.insertLayer=function(a,c){this.data.layers.splice(a,0,c)};d.prototype.updateLayers=function(a,c,d){a=this.data;for(c=0;c<a.layers.length;c++){var b=a.layers[c];b.hasOwnProperty("update")&&b.update(d)}};d.prototype.drawWorld=
function(a,c,d){var b=this.data,g=b.tilewidth,i=b.tileheight/2,h=Math.floor((this.yoffset-i)/i),e=Math.floor((this.yoffset+this.clientHeight-i+this.maxYOverdraw)/i)+1,m=Math.floor((this.xoffset+this.clientWidth-1)/g),n=Math.floor((this.xoffset-g/2-this.maxXOverdraw)/g);d.sort(function(a,c){var d=a.y-c.y;return 0!==d?d:a.h-c.h});var u=0,q=0,p,r,w,v,y,z,A,C=b.layers.length-1;for(y=0;y<b.layers.length;y++)if(v=b.layers[y],"draw"in v)v.draw(a,c);else if(v.visible){z=Math.min(e,v.rows.length-1);A=Math.max(n,
0);for(r=h;r<=z;r++){w=v.rows[r];q=r&1?b.tilewidth/2:0;for(p=m;p>=A;p--){var B=w[p];null!==B&&B.draw(a,Math.floor(-this.xoffset)+q+p*g,Math.floor(-this.yoffset)+r*i)}if(y==C)for(q=(r+2)*i;u<d.length&&q>=d[u].y;)d[u++].draw(a,this.xoffset,this.yoffset,c)}}};return d});
define("plugins/sprite/bounce",[],function(){var b=function(){var a=this.state.jogPos(this.epoch,this.sn.getNow()),a=2*a-1,a=a*a;this.h=this.bounce_base+this.bounce_height*(1-a);return!0};return function(a){a.registerSpriteUpdater("bounce",b,function(){})}});define("plugins/sprite/follow-mouse",[],function(){var b=[0,0],a=function(){this.sn.mouseWorldPos(b);this.x=b[0];this.y=b[1];return!0};return function(c){c.registerSpriteUpdater("follow_mouse",a,function(){})}});
define("plugins/sprite/link",[],function(){var b=function(){for(var a=this.link_to.length-1;0<=a;a--)this.link_to[a].sprite.x=this.x+this.link_to[a].x,this.link_to[a].sprite.y=this.y+this.link_to[a].y;return!0},a=function(){for(var a=this.link_to.length-1;0<=a;a--)this.link_to[a].sprite=this.sn.spriteMap[this.link_to[a].name]};return function(c){c.registerSpriteUpdater("link",b,a)}});
define("plugins/sprite/8way",[],function(){var b=function(){var a=this.directionx-this.x,d=2*(this.directiony-this.y);if(0===d)a=0===a?this.direction:0<a?"e":"w";else var b=a/d,a=0<=b?0.41421>b?0<d?"s":"n":2.4142<b?0<a?"e":"w":0<a?"se":"nw":-0.41421<b?0<d?"s":"n":-2.4142>b?0<a?"e":"w":0<a?"ne":"sw";this.direction=a;this.oldx=this.x;this.oldy=this.y;this.setState(this.stateName,this.direction);return!0},a=function(){this.direction="e"};return function(c){c.registerSpriteUpdater("8way",b,a)}});
define("plugins/layer/occlusion-scan",["util/js"],function(b){function a(a,c,b){this.opts=c||{};this.name=a;this.x=c.x;this.y=c.y;this.sn=b;this.collider=b.createCollider("trace",{whisker:c.whisker})}var c=b.copyProps;a.prototype.update=function(){};a.prototype.draw=function(a){var c=[0,0],b=[0,0],h=[0,0],f,k,s;for(f=-200;200>f;f+=8)a.lineWidth=1,a.strokeStyle="yellow",a.beginPath(),this.sn.mouseWorldPos(c),k=c[0]+f-this.x,s=c[1]-this.y,k=this.collider.test(Math.floor(this.x),Math.floor(this.y),Math.floor(k),
Math.floor(s),0,h),this.sn.worldToScreenPos(h[0],h[1],h),this.sn.worldToScreenPos(this.x,this.y,b),a.moveTo(b[0],b[1]),a.lineTo(h[0],h[1]),a.stroke(),a.beginPath(),a.strokeStyle=k?"red":"green",a.arc(h[0],h[1],2.5,0,2*Math.PI),a.stroke();for(f=-200;200>f;f+=8)a.lineWidth=1,a.strokeStyle="yellow",a.beginPath(),this.sn.mouseWorldPos(c),k=c[0]-this.x,s=c[1]+f-this.y,k=this.collider.test(Math.floor(this.x),Math.floor(this.y),Math.floor(k),Math.floor(s),0,h),this.sn.worldToScreenPos(h[0],h[1],h),this.sn.worldToScreenPos(this.x,
this.y,b),a.moveTo(b[0],b[1]),a.lineTo(h[0],h[1]),a.stroke(),a.beginPath(),a.strokeStyle=k?"red":"green",a.arc(h[0],h[1],2.5,0,2*Math.PI),a.stroke()};a.prototype.set=function(a){c(a,this)};return function(c){c.registerLayerPlugin("occlusion-scan",a,function(){})}});
define("sprites/composite",[],function(){function b(a,c,b,i,g){this.sn=a;this.x=c;this.y=b;this.h=i;this.endCallback=g;this.active=!0;this.sprites=[]}b.prototype.init=function(){};b.prototype.isActive=function(){if(!this.active)return!1;for(var a=!1,c=this.sprites.length-1;0<=c;c--)this.sprites[c].isActive()?a=!0:this.sprites.splice(c,1);this.active=a;!this.active&&void 0!==this.endCallback&&this.endCallback();return a};b.prototype.update=function(){};b.prototype.draw=function(a,c,b,i){if(this.active)for(var c=
this.x-c-this.def.x,b=this.y-b-this.def.y-this.h,g=0;g<this.sprites.length;g++){var h=this.sprites[g];h.drawAt(a,c+h.x,b+h.y,i)}};return b});define("plugins/fx/particles",["sprites/sprite","sprites/composite"],function(){function b(a){this.opts=a;this.number="number"===typeof a.number?a.number:a.number()}b.prototype.update=function(){return!1};return function(a){a.registerFxPlugin("particles",b,function(){})}});
define("plugins/collision/trace-collider",[],function(){function b(a,c){a=a||{};this.sn=c;if(0<a.whisker){if(this.whisker=a.whisker,this.sampleCount=a.samples?a.samples:7,3>this.sampleCount||0===(this.sampleCount&1))throw"Trace collider sample count must be an odd number 3 or higher";}else this.whisker=0;var b=c.getScreenEdges();this.leftEdge=b.le;this.rightEdge=b.re;this.topEdge=b.te;this.bottomEdge=b.be}b.prototype.test=function(a,c,b,i,g,h){var f,k=this.whisker,s=a,j=c,t=b,x=i,l;if(0===b&&0===
i)h[0]=a,h[1]=c,l=this.sn.getTilePropAtWorldPos("height",a,c),g=l>g;else{var e,m,n;if(0<k){e=2*i;m=Math.sqrt(b*b+e*e);e=b/m;m=i/m;b=Math.floor(b+k*e);i=Math.floor(i+k*m);n=Array(2*this.sampleCount);var u=Math.atan2(2*i,b)-Math.PI/2,q=Math.PI/(this.sampleCount-1),p=2*Math.floor(this.sampleCount/2),r,w;for(f=0;f<2*this.sampleCount;f+=2){var v=Math.cos(u);l=Math.sin(u);n[f]=k*v;n[f+1]=k*l/2;f===p&&(r=n[f],w=n[f+1]);u+=q}for(f=0;f<2*this.sampleCount;f+=2)n[f]-=r,n[f+1]-=w}r=a+b;w=c+i;for(var b=Math.abs(b),
i=Math.abs(i),u=a<r?1:-1,q=c<w?1:-1,p=b-i,y,v=!1;;){if(0===k){if(a<this.leftEdge||a>this.rightEdge||c<this.topEdge||c>this.bottomEdge){v=!0;break}l=this.sn.getTilePropAtWorldPos("height",a,c);if(l>g){v=!0;break}}else{y=!1;for(f=0;f<n.length;f+=2){l=a+n[f];var z=c+n[f+1];if(l<this.leftEdge||l>this.rightEdge||z<this.topEdge||z>this.bottomEdge){y=v=!0;break}l=this.sn.getTilePropAtWorldPos("height",l,z);if(l>g||void 0===l){y=v=!0;break}}}if(y)break;if(a===r&&c===w)break;f=2*p;f>-i&&(p-=i,a+=u);f<b&&(p+=
b,c+=q)}0<k&&v&&(a-=e*k,c-=m*k);v&&void 0!==h?(void 0!==h&&(h[0]=a,h[1]=c),g=b>i?(s-a)/-t:(j-c)/-x):(void 0!==h&&(h[0]=s+t,h[1]=j+x),g=1)}return 1>g};return function(a){a.registerColliderPlugin("trace",b,function(){})}});
define("plugins/default-plugins","plugins/sprite/bounce plugins/sprite/follow-mouse plugins/sprite/link plugins/sprite/8way plugins/layer/occlusion-scan plugins/fx/particles plugins/collision/trace-collider".split(" "),function(b,a,c,d,i,g,h){return function(f){b(f);a(f);c(f);d(f);i(f);g(f);h(f)}});
define("polyfills/requestAnimationFrame",[],function(){for(var b=0,a=["ms","moz","webkit","o"],c=0;c<a.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[a[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[c]+"CancelAnimationFrame"]||window[a[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=(new Date).getTime(),g=Math.max(0,16-(c-b)),h=window.setTimeout(function(){a(c+g)},g);b=c+g;return h});window.cancelAnimationFrame||
(window.cancelAnimationFrame=function(a){clearTimeout(a)})});
define("snaps","sprites/spritedef sprites/sprite input/keyboard input/mouse util/all map/staggered-isometric plugins/default-plugins polyfills/requestAnimationFrame".split(" "),function(b,a,c,d,i,g,h){function f(f,t,x){function l(){window.requestAnimationFrame(l);null!==m&&m.begin();e.now=+new Date;var a=e.now-e.lastFrameTime;e.updateFX(a);e.map.updateLayers(a);u(a);n(e.ctx);e.dbgShowRegions&&void 0!==e.map&&e.map.drawDebugRegions(e.ctx);e.dbgShowMouse&&(k(e.ctx,"Screen: "+e.mouse.x+","+e.mouse.y,
5,15),k(e.ctx,"World: "+(e.mouse.x+e.map.xoffset)+","+(e.mouse.y+e.map.yoffset),5,30),k(e.ctx,"Origin: "+e.map.xoffset+","+e.map.yoffset,5,45));e.dbgShowCounts&&k(e.ctx,"Sprites: "+e.sprites.length,5,e.clientHeight-15);if(e.dbgShowMouseTile&&void 0!==e.map){a=[0,0];e.mouseWorldPos(a);var b=[0,0];e.worldToTilePos(a[0],a[1],b);k(e.ctx,"Mouse in tile: "+b[0]+", "+b[1],5,e.clientHeight-30)}e.lastFrameTime=e.now;null!==m&&m.end()}var e=this;this.util=i;var m=null;x.showFps&&late_require(["stats"],function(a){m=
new a;a=m.domElement;a.style.position="absolute";a.style.left="0px";a.style.top="0px";document.body.appendChild(a)});this.dbgShowMouse=!!x.showMouse;this.dbgShowCounts=!!x.showCounts;this.dbgShowRegions=!!x.showRegions;this.dbgShowMouseTile=!!x.showMouseTile;this.imageCache={};this.spriteUpdaters={};this.colliders={};this.fxUpdaters={};this.layerPlugins={};this.timers={};this.activeFX=[];e.now=+new Date;t=document.getElementById(t);this.clientWidth=t.clientWidth;this.clientHeight=t.clientHeight;this.ctx=
t.getContext("2d");this.keyboard=new c;this.mouse=new d(t);this.ctx.fillStyle="#000022";this.ctx.fillRect(0,0,t.clientWidth,t.clientHeight);this.game=f;if(void 0!==f.map){if("object"!==typeof f.hitTests||void 0===f.hitTests.hit)throw"Game must define a hitTests object with at least a 'hit' property";this.map=new g(f.map,f.hitTests,this.clientWidth,this.clientHeight)}var n=e.game.draw,u=e.game.update;this.spriteDefs={};this.sprites=[];this.spriteMap={};this.lastFrameTime=+new Date;this.registerSpriteUpdater=
function(a,b,c){e.spriteUpdaters[a]={fn:b,init:c}};this.registerFxPlugin=function(a,b,c){c.call(this);e.fxUpdaters[a]=b};this.registerLayerPlugin=function(a,b,c){c.call(this);e.layerPlugins[a]=b};this.registerColliderPlugin=function(a,b,c){e.colliders[a]={fn:b,init:c}};h(this);if("function"===typeof e.game.onEngineStart)e.game.onEngineStart(this);t=new s;void 0!==this.map&&this.map.primePreloader(t);if("object"===typeof f.preloadImages){var x=function(a,b){e.imageCache[b]=a},q;for(q in f.preloadImages)t.add(f.preloadImages[q],
q,x)}if("object"===typeof e.game.spriteDefs){var f=function(a,c){var d=e.game.spriteDefs[c],f=new b(a,d.w,d.h,d.x,d.y);e.spriteDefs[c]=f;for(var g in d.states)f.addState(g,d.states[g].seq,d.states[g].dur)},p;for(p in e.game.spriteDefs)t.add(e.game.spriteDefs[p].path,p,f)}this.drawImage=function(a,b,c){e.ctx.drawImage(e.imageCache[a],b,c)};this.cls=function(){e.ctx.fillStyle="#000";e.ctx.fillRect(0,0,e.clientWidth,e.clientHeight)};this.bindKeys=function(a){for(var b=0;b<a.length;b++){var c=a[b];e.keyboard.bind(c.key,
c.action)}};this.updateFX=function(a){for(var b=e.activeFX.length-1;0<=b;b--)e.activeFX[b].update(a)||e.activeFX.splice(b,1)};this.fx=function(a,b){if(!e.fxUpdaters.hasOwnProperty(a))throw"Can't spawn FX for unregistered FX type: "+a;e.activeFX.push(new e.fxUpdaters[a](b))};this.addLayer=function(a,b,c,d){if(!e.layerPlugins.hasOwnProperty(b))throw"Can't spawn layer for unregistered layer type: "+b;a=new e.layerPlugins[b](a,c,e);e.map.insertLayer(d,a);return a};t.load(function(){void 0!==e.map&&e.map.resolveTiles();
if("function"===typeof e.game.onResourcesLoaded)e.game.onResourcesLoaded();setTimeout(l,0)},function(a){if("function"===typeof e.game.onProgress)e.game.onProgress(a,e.ctx)},function(){e.game.onLoadError()});this.actioning=function(a){return e.keyboard.actionPressed(a)};this.scroll=function(a,b){e.map.scroll(a,b)};this.getScreenEdges=function(){return e.map.getScreenEdges()};this.drawWorld=function(){this.map.drawWorld(e.ctx,e.now,e.sprites)};this.drawSpriteWorld=function(a){e.spriteMap[a].draw(e.ctx,
e.map.xoffset,e.map.yoffset,e.now)};this.mouseScreenPos=function(a){a[0]=e.mouse.x;a[1]=e.mouse.y};this.mouseWorldPos=function(a){e.map.screenToWorldPos(e.mouse.x,e.mouse.y,a)};this.worldToTilePos=function(a,b,c){this.map.worldToTilePos(a,b,c)};this.screenToTilePos=function(a,b,c){this.map.screenToTilePos(a,b,c)};this.screenToWorldPos=function(a,b,c){this.map.screenToWorldPos(a,b,c)};this.worldToScreenPos=function(a,b,c){this.map.worldToScreenPos(a,b,c)};this.getTilePropAtWorldPos=function(a,b,c){return this.map.getTilePropAtWorldPos(a,
b,c)};this.createCollider=function(a,b){if(!e.colliders.hasOwnProperty(a))throw"Warning: undefined collider plugin: "+a;return new e.colliders[a].fn(b,e)};this.nextName=1;this.spawnSprite=function(b,c,d,f,g,h,i){void 0===i&&(i={});var j=i.name;if(void 0===j)j="unnamed"+e.nextName,e.nextName++;else if(e.spriteMap.hasOwnProperty(j))throw"Warning: duplicate sprite name "+j;var b=e.spriteDefs[b],k=i.updates;if(void 0!==k)for(var k=Array(i.updates.length),l=0;l<i.updates.length;l++)k[l]=e.spriteUpdaters[i.updates[l]];
f=new a(e,b,f,g,h,i.maxloops,k,i.collider,i.endCallback);f.setState(c,d);if(void 0!==i.opts)for(var m in i.opts)f[m]=i.opts[m];f.init();e.sprites.push(f);e.spriteMap[j]=f};this.markTime=function(a,b){e.timers[a]=e.now+b};this.checkTimer=function(a,b){if(void 0===e.timers[a])return!1;var c=e.timers[a];if(0<e.now-c){if(void 0===b)delete e.timers[a];else{b=Math.max(1,b);do c+=b;while(c<e.now);e.timers[a]=c}return!0}return!1};this.sprite=function(a){return e.spriteMap[a]};this.updateSprites=function(){for(var a=
[],b=0;b<e.sprites.length;b++){var c=e.sprites[b];c.isActive(e.now)?(c.update(),a.push(c)):delete e.spriteMap[c.name]}e.sprites=a};this.getNow=function(){return e.now};this.resizeCanvas=function(){}}var k=i.debug.debugText,s=i.Preloader;f.util=i;return f});
