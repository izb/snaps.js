define("tile",[],function(){function c(a,e,c,f,d,i,g){this.img=a;this.x=e;this.y=c;this.w=f;this.h=d;this.xoverdraw=i;this.yoverdraw=g}c.prototype.draw=function(a,e,c){a.drawImage(this.img,this.x,this.y,this.w,this.h,e-this.xoverdraw,c-this.yoverdraw,this.w,this.h)};return c});
define("sprites/spritedef",[],function(){function c(a,c,f){this.seq=a;this.dur=c;this.def=f}function a(a,c,f,d,i){this.states={};this.image=a;this.w=c;this.h=f;this.x=d;this.y=i}c.prototype.jogPos=function(a,c){var f;f=(c-a)%this.dur;return f/this.dur};c.prototype.draw=function(a,c,f,d,i){var g=this.def,d=this.seq[Math.floor(this.seq.length*this.jogPos(d,i))];a.drawImage(g.image,d.x,d.y,g.w,g.h,c,f,g.w,g.h)};a.prototype.addState=function(a,h,f){for(var d=[],i=Math.floor(this.image.width/this.w),g=
0;g<h.length;g++){var p=h[g];d.push({x:this.w*(p%i),y:this.h*Math.floor(p/i)})}this.states[a]=new c(d,f,this)};return a});
define("sprites/sprite",[],function(){function c(a,e,c,f,d,i,g,p){this.def=e;this.sn=a;this.x=c;this.y=f;this.h=d;this.state=null;this.active=!0;void 0===i&&(i=0);this.maxloops=i;this.updates=g;this.endCallback=p}c.prototype.init=function(){if(void 0!==this.updates)for(var a=0;a<this.updates.length;a++)this.updates[a].init.call(this)};c.prototype.isActive=function(a){this.active&&(0<this.maxloops&&this.state.dur*this.maxloops<=a-this.epoch)&&(this.active=!1,void 0!==this.endCallback&&this.endCallback());
return this.active};c.prototype.setState=function(a,e){if(!(this.stateName===a&&this.stateExt===e)){this.stateName=a;this.stateExt=e;void 0!==e&&this.def.states.hasOwnProperty(a+"_"+e)&&(a=a+"_"+e);if(!this.def.states.hasOwnProperty(a))throw"Bad sprite definition. Missing state: "+a;this.state=this.def.states[a];this.epoch=this.sn.getNow()}};c.prototype.stateName=function(){return this.stateName};c.prototype.hasState=function(a){return this.def.states.hasOwnProperty(a)};c.prototype.morphState=function(){};
c.prototype.update=function(){if(void 0!==this.updates)for(var a=0;a<this.updates.length&&this.updates[a].fn.call(this);a++);};c.prototype.drawAt=function(a,e,c,f){this.active&&this.state.draw(a,e,c,this.epoch,f)};c.prototype.draw=function(a,e,c,f){this.drawAt(a,this.x-e-this.def.x,this.y-c-this.def.y-this.h,f)};return c});
define("input/keyboard",[],function(){return function(){var c=this;this.keymap={backspace:8,tab:9,enter:13,pause:19,capsLock:20,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,plus:187,comma:188,minus:189,period:190,shift:16,ctrl:17,alt:18,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,
num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,substract:109,decimal:110,divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};this.actions=[];this.keys=[];this.bind=function(a,e){c.actions[e]=0;c.keys[c.keymap[a]]=e};this.actionPressed=function(a){return!!c.actions[a]};window.addEventListener("keydown",function(a){var e=a.target.tagName;"keydown"!==a.type||("INPUT"===e||"TEXTAREA"===e)||(a.preventDefault(),
a=a.keyCode,(e=c.keys[a])&&(c.actions[e]=a))},!1);window.addEventListener("keyup",function(a){"keyup"===a.type&&(a.preventDefault(),(a=c.keys[a.keyCode])&&(c.actions[a]=0))},!1)}});define("input/mouse",[],function(){return function(c){var a=this;this.y=this.x=0;this.inputmap={mouse1:-1,mouse2:-3,wheelUp:-4,wheelDown:-5};c.addEventListener("mousemove",function(e){var h=c.getBoundingClientRect();a.x=e.clientX-h.left;a.y=e.clientY-h.top},!1)}});
define("util/preload",[],function(){function c(){this.batch=[];this.errorstate=!1}c.prototype.add=function(a,c,h){this.batch.push({file:a,tag:c,fnStore:h})};c.prototype.load=function(a,c,h){function f(h,b){return function(){g.errorstate||(i--,h.fnStore(b,h.tag),c(1-i/g.batch.length),0===i&&a())}}function d(){g.errorstate||(g.errorstate=!0,h())}var i=this.batch.length,g=this;c(0);for(var p=0;p<this.batch.length;p++){var j=this.batch[p],l=new Image;l.onload=f(j,l);l.onerror=d;l.src=j.file}};return c});
define("util/rnd",[],function(){var c=function(a,c){return a+Math.random()*(c-a+1)|0};return{rnd:c,fastRand:function(a,e){for(var h=[],f=1E4;0<f;f--)h.push(c(a,e));var d=0;return function(){d++;d===h.length&&(d=0);return h[d]}}}});define("util/bitmap",[],function(){return{imageToRGBAData:function(c){var a=c.width,e=c.height,h=document.createElement("canvas");h.height=e;h.width=a;h=h.getContext("2d");h.drawImage(c,0,0);return h.getImageData(0,0,a,e).data}}});
define("util/url",[],function(){return{queryStringValue:function(c){return(c=RegExp("[?&]"+c+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(c[1].replace(/\+/g," "))}}});define("util/all",["util/preload","util/rnd","util/bitmap","util/url"],function(c,a,e,h){return{Preloader:c,rnd:a,Bitmap:e,Url:h}});
define("plugins/sprite/bounce",[],function(){var c=function(){var a=this.state.jogPos(this.epoch,this.sn.getNow()),a=2*a-1,a=a*a;this.h=this.bounce_base+this.bounce_height*(1-a);return!0};return function(a){a.registerSpriteUpdater("bounce",c,function(){})}});define("plugins/sprite/follow-mouse",[],function(){var c=function(){var a=this.sn.mouseWorldPos();this.x=a.x;this.y=a.y;return!0};return function(a){a.registerSpriteUpdater("follow_mouse",c,function(){})}});
define("plugins/sprite/link",[],function(){var c=function(){for(var a=this.link_to.length-1;0<=a;a--)this.link_to[a].sprite.x=this.x+this.link_to[a].x,this.link_to[a].sprite.y=this.y+this.link_to[a].y;return!0},a=function(){for(var a=this.link_to.length-1;0<=a;a--)this.link_to[a].sprite=this.sn.spriteMap[this.link_to[a].name]};return function(e){e.registerSpriteUpdater("link",c,a)}});
define("plugins/sprite/8way",[],function(){var c=function(){var a=this.x-this.oldx,c=2*(this.y-this.oldy);if(0===c)a=0===a?this.direction:0<a?"e":"w";else var f=a/c,a=0<=f?0.41421>f?0<c?"s":"n":2.4142<f?0<a?"e":"w":0<a?"se":"nw":-0.41421<f?0<c?"s":"n":-2.4142>f?0<a?"e":"w":0<a?"ne":"sw";this.direction=a;this.oldx=this.x;this.oldy=this.y;this.setState(this.stateName,this.direction);return!0},a=function(){this.direction="e"};return function(e){e.registerSpriteUpdater("8way",c,a)}});
define("sprites/composite",[],function(){function c(a,c,h,f,d){this.sn=a;this.x=c;this.y=h;this.h=f;this.endCallback=d;this.active=!0;this.sprites=[]}c.prototype.init=function(){};c.prototype.isActive=function(){if(!this.active)return!1;for(var a=!1,c=this.sprites.length-1;0<=c;c--)this.sprites[c].isActive()?a=!0:this.sprites.splice(c,1);this.active=a;!this.active&&void 0!==this.endCallback&&this.endCallback();return a};c.prototype.update=function(){};c.prototype.draw=function(a,c,h,f){if(this.active)for(var c=
this.x-c-this.def.x,h=this.y-h-this.def.y-this.h,d=0;d<this.sprites.length;d++){var i=this.sprites[d];i.drawAt(a,c+i.x,h+i.y,f)}};return c});define("plugins/fx/particles",["sprites/sprite","sprites/composite"],function(){function c(a){this.opts=a;this.number="number"===typeof a.number?a.number:a.number()}c.prototype.update=function(){return!1};return function(a){a.registerFxPlugin("particles",c,function(){})}});
define("plugins/default-plugins",["plugins/sprite/bounce","plugins/sprite/follow-mouse","plugins/sprite/link","plugins/sprite/8way","plugins/fx/particles"],function(c,a,e,h,f){return function(d){c(d);a(d);e(d);h(d);f(d)}});
define("polyfills/requestAnimationFrame",[],function(){for(var c=0,a=["ms","moz","webkit","o"],e=0;e<a.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[a[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[e]+"CancelAnimationFrame"]||window[a[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var e=(new Date).getTime(),d=Math.max(0,16-(e-c)),i=window.setTimeout(function(){a(e+d)},d);c=e+d;return i});window.cancelAnimationFrame||
(window.cancelAnimationFrame=function(a){clearTimeout(a)})});
define("snaps","tile sprites/spritedef sprites/sprite input/keyboard input/mouse util/all plugins/default-plugins polyfills/requestAnimationFrame".split(" "),function(c,a,e,h,f,d,i){function g(g,j,l){function v(){window.requestAnimationFrame(v);null!==q&&q.begin();b.now=+new Date;var a=b.now-b.lastFrameTime;b.updateFX(a);z(a);A(b.ctx);if(b.dbgShowRegions&&void 0!==b.map){var c,k,e,d,f,h,a=b.map.tilewidth,g=b.map.tileheight/2;f=Math.floor((b.yoffset-g)/g);k=Math.floor((b.yoffset+b.clientHeight-g+b.maxYOverdraw)/
g)+1;e=Math.floor((b.xoffset+b.clientWidth-1)/a);h=Math.floor((b.xoffset-a/2-b.maxXOverdraw)/a);c=b.map.layers[0];c=Math.min(k,c.rows.length-1);for(k=Math.max(h,0);f<=c;f++){var i;f&1?(h=b.map.tilewidth/2,i="#f00"):(h=0,i="#0f0");for(d=e;d>=k;d--){b.ctx.strokeStyle=i;var s=Math.floor(-b.xoffset)+h+d*a,j=Math.floor(-b.yoffset)+f*g,l=b.map.tilewidth,m=b.map.tileheight;b.ctx.strokeRect(s,j,l,m);b.ctx.strokeStyle="#aaa";b.ctx.beginPath();b.ctx.moveTo(s,j+m/2);b.ctx.lineTo(s+l/2,j);b.ctx.lineTo(s+l,j+
m/2);b.ctx.lineTo(s+l/2,j+m);b.ctx.closePath();b.ctx.stroke()}}for(n=0;n<b.map.layers.length;n++){c=b.map.layers[n];for(f=0;f<c.rows.length;f++){e=c.rows[f];h=f&1?b.map.tilewidth/2:0;for(d=e.length-1;0<=d;d--)r(d+","+f,85+Math.floor(-b.xoffset)+h+d*a,55+Math.floor(-b.yoffset)+f*g)}}}b.dbgShowMouse&&(r("Screen: "+b.mouse.x+","+b.mouse.y,5,15),r("World: "+(b.mouse.x+b.xoffset)+","+(b.mouse.y+b.yoffset),5,30),r("Origin: "+b.xoffset+","+b.yoffset,5,45));b.dbgShowCounts&&r("Sprites: "+b.sprites.length,
5,b.clientHeight-15);b.dbgShowMouseTile&&(a=b.mouseWorldPos(),a=b.worldToTilePos(a.x,a.y),r("Mouse in tile: "+a.x+", "+a.y,5,b.clientHeight-30));b.lastFrameTime=b.now;null!==q&&q.end()}var b=this;this.util=d;var q=null;l.showFps&&late_require(["stats"],function(b){q=new b;b=q.domElement;b.style.position="absolute";b.style.left="0px";b.style.top="0px";document.body.appendChild(b)});this.dbgShowMouse=!!l.showMouse;this.dbgShowCounts=!!l.showCounts;this.dbgShowRegions=!!l.showRegions;this.dbgShowMouseTile=
!!l.showMouseTile;this.imageCache={};this.spriteUpdaters={};this.fxUpdaters={};this.timers={};this.activeFX=[];b.now=+new Date;j=document.getElementById(j);this.clientWidth=j.clientWidth;this.clientHeight=j.clientHeight;this.ctx=j.getContext("2d");this.keyboard=new h;this.mouse=new f(j);this.ctx.fillStyle="#000022";this.ctx.fillRect(0,0,j.clientWidth,j.clientHeight);this.game=g;var m=g.map;this.maxyoffset=this.maxxoffset=this.minyoffset=this.minxoffset=0;void 0!==m&&(this.map=m,this.minxoffset=m.tilewidth/
2,this.minyoffset=m.tileheight/2,this.maxxoffset=m.width*m.tilewidth-this.clientWidth,this.maxyoffset=m.height*(m.tileheight/2)-this.clientHeight);this.xoffset=this.minxoffset;this.yoffset=this.maxyoffset;this.maxYOverdraw=this.maxXOverdraw=0;var A=b.game.draw,z=b.game.update;this.spriteDefs={};this.sprites=[];this.spriteMap={};this.lastFrameTime=+new Date;this.registerSpriteUpdater=function(a,c,k){b.spriteUpdaters[a]={fn:c,init:k}};this.registerFxPlugin=function(a,c,k){k.call(this);b.fxUpdaters[a]=
c};i(this);if("function"===typeof b.game.onEngineStart)b.game.onEngineStart(this);j=new d.Preloader;if(void 0!==m){for(var l=function(b,a){a.image=b},n=0;n<m.tilesets.length;n++){var x=m.tilesets[n];j.add(x.image,x,l)}if("object"!==typeof g.hitTests||void 0===g.hitTests.hit)throw"Game must define a hitTests object with at least a 'hit' property";var l=function(b,a){if(b.width!==m.tilewidth||b.height!==m.tileheight)throw"Hit test image "+a+" does not match map tile size";"hit"===a&&(this.hitTest=d.Bitmap.imageToRGBAData(b))},
t;for(t in g.hitTests)j.add(g.hitTests[t],t,l)}if("object"===typeof g.preloadImages){t=function(a,c){b.imageCache[c]=a};for(var y in g.preloadImages)j.add(g.preloadImages[y],y,t)}if("object"===typeof b.game.spriteDefs){var g=function(c,w){var k=b.game.spriteDefs[w],e=new a(c,k.w,k.h,k.x,k.y);b.spriteDefs[w]=e;for(var d in k.states)e.addState(d,k.states[d].seq,k.states[d].dur)},u;for(u in b.game.spriteDefs)j.add(b.game.spriteDefs[u].path,u,g)}this.drawImage=function(a,c,k){b.ctx.drawImage(b.imageCache[a],
c,k)};this.cls=function(){b.ctx.fillStyle="#000";b.ctx.fillRect(0,0,b.clientWidth,b.clientHeight)};this.bindKeys=function(a){for(var c=0;c<a.length;c++){var k=a[c];b.keyboard.bind(k.key,k.action)}};this.updateFX=function(a){for(var c=b.activeFX.length-1;0<=c;c--)b.activeFX[c].update(a)||b.activeFX.splice(c,1)};this.fx=function(a,c){if(!b.fxUpdaters.hasOwnProperty(a))throw"Can't spawn FX for unregistered FX type: "+a;b.activeFX.push(new b.fxUpdaters[a](c))};j.load(function(){if(void 0!==b.map){var a,
e,k,d;for(k=b.map.tilesets.length-1;0<=k;k--)d=b.map.tilesets[k],d.xspan=Math.floor(d.imagewidth/d.tilewidth),d.yspan=Math.floor(d.imageheight/d.tileheight);for(a=0;a<b.map.layers.length;a++){var f=b.map.layers[a];f.rows=[];var h=[];for(e=0;e<f.data.length;e++){var g=f.data[e];for(k=b.map.tilesets.length-1;0<=k&&!(d=b.map.tilesets[k],d.firstgid<=g);k--);g-=d.firstgid;k=Math.floor(g/d.xspan);var g=g-d.xspan*k,i=d.tileheight-b.map.tileheight;b.maxXOverdraw=Math.max(d.tilewidth-b.map.tilewidth,b.maxXOverdraw);
b.maxYOverdraw=Math.max(i,b.maxYOverdraw);h.push(new c(d.image,g*d.tilewidth,k*d.tileheight,d.tilewidth,d.tileheight,d.tilewidth-b.map.tilewidth,d.tileheight-b.map.tileheight));h.length>=f.width&&(f.rows.push(h),h=[])}}}if("function"===typeof b.game.onResourcesLoaded)b.game.onResourcesLoaded();setTimeout(v,0)},function(a){if("function"===typeof b.game.onProgress)b.game.onProgress(a,b.ctx)},function(){b.game.onLoadError()});this.actioning=function(a){return b.keyboard.actionPressed(a)};this.scroll=
function(a,c){b.xoffset+=a;b.yoffset+=c;b.xoffset<b.minxoffset?b.xoffset=b.minxoffset:b.xoffset>b.maxxoffset&&(b.xoffset=b.maxxoffset);b.yoffset<b.minyoffset?b.yoffset=b.minyoffset:b.yoffset>b.maxyoffset&&(b.yoffset=b.maxyoffset)};var r=function(a,c,d){b.ctx.fillStyle="black";b.ctx.font="bold 16px Arial";b.ctx.fillText(a,c+1,d);b.ctx.fillText(a,c-1,d);b.ctx.fillText(a,c,d+1);b.ctx.fillText(a,c,d-1);b.ctx.fillStyle="white";b.ctx.fillText(a,c,d)};this.drawWorld=function(){var a=b.map.tilewidth,c=b.map.tileheight/
2,d=Math.floor((b.yoffset-c)/c),e=Math.floor((b.yoffset+b.clientHeight-c+b.maxYOverdraw)/c)+1,f=Math.floor((b.xoffset+b.clientWidth-1)/a),h=Math.floor((b.xoffset-a/2-b.maxXOverdraw)/a);this.sprites.sort(function(b,a){return b.h-a.h});this.sprites.sort(function(b,a){return b.y-a.y});var g=0,i=0,j,l,m,p,n,q,r;for(n=0;n<b.map.layers.length;n++){p=b.map.layers[n];q=Math.min(e,p.rows.length-1);r=Math.max(h,0);for(l=d;l<=q;l++){m=p.rows[l];i=l&1?b.map.tilewidth/2:0;for(j=f;j>=r;j--)m[j].draw(b.ctx,Math.floor(-b.xoffset)+
i+j*a,Math.floor(-b.yoffset)+l*c);if(1==n)for(i=(l+2)*c;g<this.sprites.length&&i>=this.sprites[g].y;)b.sprites[g++].draw(b.ctx,b.xoffset,b.yoffset,b.now)}}};this.drawSprite=function(a){b.spriteMap[a].draw(b.ctx,b.xoffset,b.yoffset,b.now)};this.mouseScreenPos=function(){return{x:b.mouse.x,y:b.mouse.y}};this.mouseWorldPos=function(){return{x:b.mouse.x+b.xoffset,y:b.mouse.y+b.yoffset}};this.worldToTilePos=function(a,c){var d=b.map.tilewidth,e=b.map.tileheight;if(0===b.hitTest[Math.floor(a%d)+Math.floor(c%
e)*d])return{x:2*f,y:2*g};var f=Math.floor((a+d/2)/d),g=Math.floor((c+e/2)/e);return{x:2*f+1,y:2*g+1}};this.screenToTilePos=function(a,c){return b.worldToTilePos(a+b.xoffset,c+b.yoffset)};this.screenToWorldPos=function(a,c){return{x:a+b.xoffset,y:c+b.yoffset}};this.nextName=1;this.spawnSprite=function(a,c,d,f,g,h,i){void 0===i&&(i={});var j=i.name;if(void 0===j)j="unnamed"+b.nextName,b.nextName++;else if(b.spriteMap.hasOwnProperty(j))throw"Warning: duplicate sprite name "+j;var a=b.spriteDefs[a],
l=i.updates;if(void 0!==l)for(var l=Array(i.updates.length),m=0;m<i.updates.length;m++)l[m]=b.spriteUpdaters[i.updates[m]];f=new e(b,a,f,g,h,i.maxloops,l,i.endCallback);f.setState(c,d);if(void 0!==i.opts)for(var n in i.opts)f[n]=i.opts[n];f.init();b.sprites.push(f);b.spriteMap[j]=f};this.markTime=function(a,c){b.timers[a]=b.now+c};this.checkTimer=function(a,c){if(void 0===b.timers[a])return!1;var d=b.timers[a];if(0<b.now-d){if(void 0===c)delete b.timers[a];else{c=Math.max(1,c);do d+=c;while(d<b.now);
b.timers[a]=d}return!0}return!1};this.moveSprite=function(a,c,d,e){a=b.spriteMap[a];a.x=c;a.y=d;void 0!==e&&(a.h=e)};this.updateSprites=function(){for(var a=[],c=0;c<b.sprites.length;c++){var d=b.sprites[c];d.isActive(b.now)?(d.update(),a.push(d)):delete b.spriteMap[d.name]}b.sprites=a};this.getNow=function(){return b.now};this.resizeCanvas=function(){}}g.util=d;return g});
