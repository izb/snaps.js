define("tile",[],function(){function c(b,e,c,d,j,i,f){this.img=b;this.x=e;this.y=c;this.w=d;this.h=j;this.xoverdraw=i;this.yoverdraw=f}c.prototype.draw=function(b,e,c){b.drawImage(this.img,this.x,this.y,this.w,this.h,e-this.xoverdraw,c-this.yoverdraw,this.w,this.h)};return c});
define("sprites/spritedef",[],function(){function c(b,c,d){this.seq=b;this.dur=c;this.def=d}function b(b,c,d,j,i){this.states={};this.image=b;this.w=c;this.h=d;this.x=j;this.y=i}c.prototype.jogPos=function(b,c){var d;d=(c-b)%this.dur;return d/this.dur};c.prototype.draw=function(b,c,d,j,i){var f=this.def,j=this.seq[Math.floor(this.seq.length*this.jogPos(j,i))];b.drawImage(f.image,j.x,j.y,f.w,f.h,c,d,f.w,f.h)};b.prototype.addState=function(b,l,d){for(var j=[],i=Math.floor(this.image.width/this.w),f=
0;f<l.length;f++){var g=l[f];j.push({x:this.w*(g%i),y:this.h*Math.floor(g/i)})}this.states[b]=new c(j,d,this)};return b});
define("sprites/sprite",[],function(){function c(b,e,c,d,j,i,f){this.def=e;this.eng=b;this.x=c;this.y=d;this.h=j;this.state=null;this.active=!0;void 0===i&&(i=0);this.maxloops=i;this.updates=f}c.prototype.init=function(){if(void 0!==this.updates)for(var b=0;b<this.updates.length;b++)this.updates[b].init.call(this)};c.prototype.isActive=function(b){0<this.maxloops&&this.state.dur*this.maxloops<=b-this.epoch&&(this.active=!1);return this.active};c.prototype.setState=function(b,e){if(!(this.stateName===
b&&this.stateExt===e)){this.stateName=b;this.stateExt=e;void 0!==e&&(b=b+"_"+e);if(!this.def.states.hasOwnProperty(b))throw"Bad sprite definition. Missing state: "+b;this.state=this.def.states[b];this.epoch=this.eng.getNow()}};c.prototype.stateName=function(){return this.stateName};c.prototype.hasState=function(b){return this.def.states.hasOwnProperty(b)};c.prototype.morphState=function(){};c.prototype.update=function(){if(void 0!==this.updates)for(var b=0;b<this.updates.length&&this.updates[b].fn.call(this);b++);
};c.prototype.draw=function(b,e,c,d){this.active&&this.state.draw(b,this.x-e-this.def.x,this.y-c-this.def.y-this.h,this.epoch,d)};return c});
define("input/keyboard",[],function(){return function(){var c=this;this.keymap={backspace:8,tab:9,enter:13,pause:19,capsLock:20,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,plus:187,comma:188,minus:189,period:190,shift:16,ctrl:17,alt:18,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,
num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,substract:109,decimal:110,divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};this.actions=[];this.keys=[];this.bind=function(b,e){c.actions[e]=0;c.keys[c.keymap[b]]=e};this.actionPressed=function(b){return!!c.actions[b]};window.addEventListener("keydown",function(b){var e=b.target.tagName;"keydown"!==b.type||("INPUT"===e||"TEXTAREA"===e)||(b.preventDefault(),
b=b.keyCode,(e=c.keys[b])&&(c.actions[e]=b))},!1);window.addEventListener("keyup",function(b){"keyup"===b.type&&(b.preventDefault(),(b=c.keys[b.keyCode])&&(c.actions[b]=0))},!1)}});define("input/mouse",[],function(){return function(c){var b=this;this.y=this.x=0;this.inputmap={mouse1:-1,mouse2:-3,wheelUp:-4,wheelDown:-5};c.addEventListener("mousemove",function(e){var l=c.getBoundingClientRect();b.x=e.clientX-l.left;b.y=e.clientY-l.top},!1)}});
define("util/preload",[],function(){function c(){this.batch=[];this.errorstate=!1}c.prototype.add=function(b,c,l){this.batch.push({file:b,tag:c,fnStore:l})};c.prototype.load=function(b,c,l){function d(a,d){return function(){f.errorstate||(i--,a.fnStore(d,a.tag),c(1-i/f.batch.length),0===i&&b())}}function j(){f.errorstate||(f.errorstate=!0,l())}var i=this.batch.length,f=this;c(0);for(var g=0;g<this.batch.length;g++){var m=this.batch[g],n=new Image;n.onload=d(m,n);n.onerror=j;n.src=m.file}};return c});
define("plugins/sprite/bounce",[],function(){var c=function(){var b=this.state.jogPos(this.epoch,this.eng.getNow()),b=2*b-1,b=b*b;this.h=this.bounce_base+this.bounce_height*(1-b);return!0};return function(b){b.registerSpriteUpdater("bounce",c,function(){})}});define("plugins/sprite/follow-mouse",[],function(){var c=function(){var b=this.eng.mouseWorldPos();this.x=b.x;this.y=b.y;return!0};return function(b){b.registerSpriteUpdater("follow_mouse",c,function(){})}});
define("plugins/sprite/link",[],function(){var c=function(){for(var b=this.link_to.length-1;0<=b;b--)this.link_to[b].x=this.x,this.link_to[b].y=this.y;return!0},b=function(){for(var b=this.link_to.length-1;0<=b;b--)this.link_to[b]=this.eng.spriteMap[this.link_to[b]]};return function(e){e.registerSpriteUpdater("link",c,b)}});
define("plugins/sprite/8way",[],function(){var c=function(){var b=this.x-this.oldx,c=2*(this.y-this.oldy);if(0===c)b=0===b?this.direction:0<b?"e":"w";else var d=b/c,b=0<=d?0.5>d?0<c?"s":"n":2<d?0<b?"e":"w":0<b?"se":"nw":-0.5<d?0<c?"s":"n":-2>d?0<b?"e":"w":0<b?"ne":"sw";this.direction=b;this.oldx=this.x;this.oldy=this.y;this.setState(this.stateName,this.direction);return!0},b=function(){this.direction="e"};return function(e){e.registerSpriteUpdater("8way",c,b)}});
define("plugins/default-plugins",["plugins/sprite/bounce","plugins/sprite/follow-mouse","plugins/sprite/link","plugins/sprite/8way"],function(c,b,e,l){return function(d){c(d);b(d);e(d);l(d)}});
define("polyfills/requestAnimationFrame",[],function(){for(var c=0,b=["ms","moz","webkit","o"],e=0;e<b.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[b[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[e]+"CancelAnimationFrame"]||window[b[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var e=(new Date).getTime(),j=Math.max(0,16-(e-c)),i=window.setTimeout(function(){b(e+j)},j);c=e+j;return i});window.cancelAnimationFrame||
(window.cancelAnimationFrame=function(b){clearTimeout(b)})});
define("snaps","tile sprites/spritedef sprites/sprite input/keyboard input/mouse util/preload plugins/default-plugins polyfills/requestAnimationFrame".split(" "),function(c,b,e,l,d,j,i){return function(f,g,m){function n(){window.requestAnimationFrame(n);null!==r&&r.begin();a.now=+new Date;var b=a.now-a.lastFrameTime,c=1E3/60,b=Math.max(16,Math.floor(((b+12)/c|0)*c));x(b);y(a.ctx);var k,u,e,d,h,f,b=a.map.tilewidth,c=a.map.tileheight/2;h=Math.floor((a.yoffset-c)/c);u=Math.floor((a.yoffset+a.clientHeight-
c+a.maxYOverdraw)/c)+1;e=Math.floor((a.xoffset+a.clientWidth-1)/b);f=Math.floor((a.xoffset-b/2-a.maxXOverdraw)/b);if(a.dbgShowRegions){k=a.map.layers[0];k=Math.min(u,k.rows.length-1);for(u=Math.max(f,0);h<=k;h++){var g;h&1?(f=a.map.tilewidth/2,g="#f00"):(f=0,g="#0f0");for(d=e;d>=u;d--){a.ctx.strokeStyle=g;var j=Math.floor(-a.xoffset)+f+d*b,i=Math.floor(-a.yoffset)+h*c,l=a.map.tilewidth,p=a.map.tileheight;a.ctx.strokeRect(j,i,l,p);a.ctx.strokeStyle="#aaa";a.ctx.beginPath();a.ctx.moveTo(j,i+p/2);a.ctx.lineTo(j+
l/2,i);a.ctx.lineTo(j+l,i+p/2);a.ctx.lineTo(j+l/2,i+p);a.ctx.closePath();a.ctx.stroke()}}for(q=0;q<a.map.layers.length;q++){k=a.map.layers[q];for(h=0;h<k.rows.length;h++){e=k.rows[h];f=h&1?a.map.tilewidth/2:0;for(d=e.length-1;0<=d;d--)s(d+","+h,85+Math.floor(-a.xoffset)+f+d*b,55+Math.floor(-a.yoffset)+h*c)}}}a.dbgShowMouse&&(s("Screen: "+a.mouse.x+","+a.mouse.y,5,15),s("World: "+(a.mouse.x+a.xoffset)+","+(a.mouse.y+a.yoffset),5,30),s("Origin: "+a.xoffset+","+a.yoffset,5,45));a.dbgShowCounts&&s("Sprites: "+
a.sprites.length,5,a.clientHeight-15);a.lastFrameTime=a.now;null!==r&&r.end()}var a=this,r=null;m.showFps&&late_require(["stats"],function(a){r=new a;a=r.domElement;a.style.position="absolute";a.style.left="0px";a.style.top="0px";document.body.appendChild(a)});this.dbgShowMouse=!!m.showMouse;this.dbgShowCounts=!!m.showCounts;this.dbgShowRegions=!!m.showRegions;this.imageCache={};this.spriteUpdaters={};this.timers={};a.now=+new Date;g=document.getElementById(g);this.clientWidth=g.clientWidth;this.clientHeight=
g.clientHeight;this.ctx=g.getContext("2d");this.keyboard=new l;this.mouse=new d(g);this.ctx.fillStyle="#000022";this.ctx.fillRect(0,0,g.clientWidth,g.clientHeight);this.game=f;this.map=g=f.map;this.minxoffset=g.tilewidth/2;this.minyoffset=g.tileheight/2;this.maxxoffset=g.width*g.tilewidth-this.clientWidth;this.maxyoffset=g.height*(g.tileheight/2)-this.clientHeight;this.xoffset=this.minxoffset;this.yoffset=this.maxyoffset;this.maxYOverdraw=this.maxXOverdraw=0;var y=a.game.draw,x=a.game.update;this.spriteDefs=
{};this.sprites=[];this.spriteMap={};this.lastFrameTime=+new Date;this.registerSpriteUpdater=function(b,c,k){a.spriteUpdaters[b]={fn:c,init:k}};i(this);if("function"===typeof a.game.onEngineStart)a.game.onEngineStart(this);for(var f=new j,m=function(a,b){b.image=a},q=0;q<g.tilesets.length;q++){var v=g.tilesets[q];f.add(v.image,v,m)}if("object"===typeof a.game.preloadImages){var g=function(b,c){a.imageCache[c]=b},t;for(t in a.game.preloadImages)f.add(a.game.preloadImages[t],t,g)}if("object"===typeof a.game.spriteDefs){t=
function(c,e){var k=a.game.spriteDefs[e],d=new b(c,k.w,k.h,k.x,k.y);a.spriteDefs[e]=d;for(var f in k.states)d.addState(f,k.states[f].seq,k.states[f].dur)};for(var w in a.game.spriteDefs)f.add(a.game.spriteDefs[w].path,w,t)}this.drawImage=function(b,c,k){a.ctx.drawImage(a.imageCache[b],c,k)};this.cls=function(){a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,a.clientWidth,a.clientHeight)};this.bindKeys=function(b){for(var c=0;c<b.length;c++){var k=b[c];a.keyboard.bind(k.key,k.action)}};f.load(function(){var b,
e,k,d;for(k=a.map.tilesets.length-1;0<=k;k--)d=a.map.tilesets[k],d.xspan=Math.floor(d.imagewidth/d.tilewidth),d.yspan=Math.floor(d.imageheight/d.tileheight);for(b=0;b<a.map.layers.length;b++){var f=a.map.layers[b];f.rows=[];var g=[];for(e=0;e<f.data.length;e++){var h=f.data[e];for(k=a.map.tilesets.length-1;0<=k&&!(d=a.map.tilesets[k],d.firstgid<=h);k--);h-=d.firstgid;k=Math.floor(h/d.xspan);var h=h-d.xspan*k,j=d.tileheight-a.map.tileheight;a.maxXOverdraw=Math.max(d.tilewidth-a.map.tilewidth,a.maxXOverdraw);
a.maxYOverdraw=Math.max(j,a.maxYOverdraw);g.push(new c(d.image,h*d.tilewidth,k*d.tileheight,d.tilewidth,d.tileheight,d.tilewidth-a.map.tilewidth,d.tileheight-a.map.tileheight));g.length>=f.width&&(f.rows.push(g),g=[])}}if("function"===typeof a.game.onResourcesLoaded)a.game.onResourcesLoaded();setTimeout(n,0)},function(b){if("function"===typeof a.game.onProgress)a.game.onProgress(b,a.ctx)},function(){a.game.onLoadError()});this.actioning=function(b){return a.keyboard.actionPressed(b)};this.scroll=
function(b,c){a.xoffset+=b;a.yoffset+=c;a.xoffset<a.minxoffset?a.xoffset=a.minxoffset:a.xoffset>a.maxxoffset&&(a.xoffset=a.maxxoffset);a.yoffset<a.minyoffset?a.yoffset=a.minyoffset:a.yoffset>a.maxyoffset&&(a.yoffset=a.maxyoffset)};var s=function(b,c,d){a.ctx.fillStyle="black";a.ctx.font="bold 16px Arial";a.ctx.fillText(b,c+1,d);a.ctx.fillText(b,c-1,d);a.ctx.fillText(b,c,d+1);a.ctx.fillText(b,c,d-1);a.ctx.fillStyle="white";a.ctx.fillText(b,c,d)};this.drawWorld=function(){var b=a.map.tilewidth,c=a.map.tileheight/
2,d=Math.floor((a.yoffset-c)/c),e=Math.floor((a.yoffset+a.clientHeight-c+a.maxYOverdraw)/c)+1,f=Math.floor((a.xoffset+a.clientWidth-1)/b),g=Math.floor((a.xoffset-b/2-a.maxXOverdraw)/b);this.sprites.sort(function(a,b){return a.h-b.h});this.sprites.sort(function(a,b){return a.y-b.y});var h=0,j=0,i,l,m,n,p,q,r;for(p=0;p<a.map.layers.length;p++){n=a.map.layers[p];q=Math.min(e,n.rows.length-1);r=Math.max(g,0);for(l=d;l<=q;l++){m=n.rows[l];j=l&1?a.map.tilewidth/2:0;for(i=f;i>=r;i--)m[i].draw(a.ctx,Math.floor(-a.xoffset)+
j+i*b,Math.floor(-a.yoffset)+l*c);if(1==p)for(j=(l+2)*c;h<this.sprites.length&&j>=this.sprites[h].y;)a.sprites[h++].draw(a.ctx,a.xoffset,a.yoffset,a.now)}}};this.mouseScreenPos=function(){return{x:a.mouse.x,y:a.mouse.y}};this.mouseWorldPos=function(){return{x:a.mouse.x+a.xoffset,y:a.mouse.y+a.yoffset}};this.nextName=1;this.spawnSprite=function(b,c,d,f,g,j,h){void 0===h&&(h={});void 0===h.name&&(h.name="unnamed"+a.nextName,a.nextName++);var b=a.spriteDefs[b],i=h.updates;if(void 0!==i)for(var i=Array(h.updates.length),
l=0;l<h.updates.length;l++)i[l]=a.spriteUpdaters[h.updates[l]];f=new e(a,b,f,g,j,h.maxloops,i);f.setState(c,d);if(void 0!==h.opts)for(var m in h.opts)f[m]=h.opts[m];f.init();a.sprites.push(f);a.spriteMap[h.name]=f};this.markTime=function(b,c){a.timers[b]=a.now+c};this.checkTimer=function(b,c){if(void 0===a.timers[b])return!1;var d=a.timers[b];if(0<a.now-d){if(void 0===c)delete a.timers[b];else{c=Math.max(1,c);do d+=c;while(d<a.now);a.timers[b]=d}return!0}return!1};this.moveSprite=function(b,c,d,e){b=
a.spriteMap[b];b.x=c;b.y=d;void 0!==e&&(b.h=e)};this.updateSprites=function(){for(var b=[],c=0;c<a.sprites.length;c++){var d=a.sprites[c];d.isActive(a.now)?(d.update(),b.push(d)):delete a.spriteMap[d.name]}a.sprites=b};this.getNow=function(){return a.now};this.resizeCanvas=function(){}}});
