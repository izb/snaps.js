define("sprites/spritedef",[],function(){function a(a,b,d){this.seq=a;this.dur=b;this.def=d}function d(a,b,d,g,h){this.states={};this.image=a;this.w=b;this.h=d;this.x=g;this.y=h}a.prototype.jogPos=function(a,b){var d;d=(b-a)%this.dur;return d/this.dur};a.prototype.draw=function(a,b,d,g,h,i){var k=this.def,g=this.seq[i?this.seq.length-1:Math.floor(this.seq.length*this.jogPos(g,h))];a.drawImage(k.image,g[0],g[1],k.w,k.h,b,d,k.w,k.h)};d.prototype.addState=function(d,b,f){for(var g=[],h=Math.floor(this.image.width/
this.w),i=0;i<b.length;i++){var k=b[i];g.push([this.w*(k%h),this.h*Math.floor(k/h)])}this.states[d]=new a(g,f,this)};return d});
define("sprites/sprite",[],function(){function a(a,c,b,f,g,h){h=h||{};this.def=c;this.sn=a;this.x="function"===typeof b?b():b;this.y="function"===typeof f?f():f;this.h="function"===typeof g?g():g;this.state=null;this.active=!0;this.maxloops=void 0===h.maxloops?0:"function"===typeof h.maxloops?h.maxloops():h.maxloops;this.updates=h.updates;if(void 0!==this.updates)for(a=0;a<this.updates.length;a++)this.updates[a].sprite=this;this.endCallback=h.endCallback;this.collider=h.collider;this.autoRemove=h.autoRemove;
void 0===this.autoRemove&&(this.autoRemove=!0);this.collisionPoint=[0,0];this.quantizedHeight=!!h.quantizedHeight}a.prototype.init=function(){if(void 0!==this.updates)for(var a=0;a<this.updates.length;a++)this.updates[a].init()};a.prototype.maxDuration=function(){return 0===this.maxloops?0:this.state.dur*this.maxloops};a.prototype.isActive=function(a){this.active&&(0<this.maxloops&&this.state.dur*this.maxloops<=a-this.epoch)&&(this.active=!1,void 0!==this.endCallback&&this.autoRemove&&this.endCallback());
return this.active||!this.autoRemove};a.prototype.setState=function(a,c){this.active=!0;if(!(this.stateName===a&&this.stateExt===c)){this.stateName=a;this.stateExt=c;void 0!==c&&this.def.states.hasOwnProperty(a+"_"+c)&&(a=a+"_"+c);if(!this.def.states.hasOwnProperty(a))throw"Bad sprite definition. Missing state: "+a;this.state=this.def.states[a];this.epoch=this.sn.getNow()}};a.prototype.stateName=function(){return this.stateName};a.prototype.hasState=function(a){return this.def.states.hasOwnProperty(a)};
a.prototype.morphState=function(){};a.prototype.update=function(a){if(void 0!==this.updates)for(var c=0;c<this.updates.length&&this.updates[c].update(a);c++);};a.prototype.drawAt=function(a,c,b,f){(this.active||!this.autoRemove)&&this.state.draw(a,c,b,this.epoch,f,!this.active&&!this.autoRemove)};a.prototype.moveTo=function(a,c,b){void 0!==b&&(b-=this.h);this.move(a-this.x,c-this.y,b)};a.prototype.move=function(a,c,b){if(a||c||b){var f;void 0!==this.collider?(f=this.collider.test(this.x,this.y,a,
c,this.h,this.collisionPoint),this.x=this.collisionPoint[0],this.y=this.collisionPoint[1]):(this.x+=a,this.y+=c);this.directionx=this.x+a;this.directiony=this.y+c;void 0!==b&&(this.h=1>f&&!this.quantizedHeight?this.h+b*f:this.h+b)}};a.prototype.setDirection=function(a,c){this.directionx=a;this.directiony=c};a.prototype.draw=function(a,c,b,f){this.drawAt(a,this.x-c-this.def.x|0,this.y-b-this.def.y-this.h|0,f)};return a});
define("util/js",[],function(){HTMLCanvasElement.prototype.relCoords=function(a,d,c){var b=this.getBoundingClientRect();c[0]=a-b.left-window.pageXOffset;c[1]=d-b.top-window.pageYOffset};return{copyProps:function(a,d){for(var c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);return d},clone:function(a){var d={},c;for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);return d}}});
define("sprites/composite",["util/js","sprites/sprite"],function(a,d){function c(a,b,c,d){this.sn=a;this.x=b;this.y=c;this.endCallback=d;this.active=!0;this.sprites=[]}var b=a.copyProps,f=a.clone;c.prototype.init=function(){};c.prototype.addSprite=function(a,c,i,k,l,j){void 0===j&&(j={});var a=this.sn.spriteDefs[a],q=j.updates;if(void 0!==q)for(var q=Array(j.updates.length),r=0;r<j.updates.length;r++)q[r]=new this.sn.spriteUpdaters[j.updates[r].name],b(j.updates[r],q[r]);j=f(j);j.updates=q;i=new d(this.sn,
a,i,k,l,j);i.setState(c);if(void 0!==j.opts)for(var m in j.opts)i[m]=j.opts[m];i.init();this.sprites.push(i);return i};c.prototype.isActive=function(a){if(!this.active)return!1;for(var b=!1,c=this.sprites.length-1;0<=c;c--)this.sprites[c].isActive(a)?b=!0:this.sprites.splice(c,1);this.active=b;!this.active&&void 0!==this.endCallback&&this.endCallback();return b};c.prototype.update=function(a,b){for(var c=this.sprites.length-1;0<=c;c--)void 0!==b&&b(this.sprites[c],a),this.sprites[c].update()};c.prototype.draw=
function(a,b,c,d){if(this.active)for(var b=this.x-b,c=this.y-c,f=0;f<this.sprites.length;f++){var j=this.sprites[f];j.isActive(d)&&j.drawAt(a,b+j.x-j.def.y,c+j.y-j.h-j.def.y,d)}};return c});
define("input/keyboard",[],function(){return function(){var a=this;this.keymap={backspace:8,tab:9,enter:13,pause:19,capsLock:20,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,plus:187,comma:188,minus:189,period:190,shift:16,ctrl:17,alt:18,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,
num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,substract:109,decimal:110,divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};this.actions=[];this.keys=[];this.bind=function(d,c){a.actions[c]=0;a.keys[a.keymap[d]]=c};this.actionPressed=function(d){return!!a.actions[d]};window.addEventListener("keydown",function(d){var c=d.target.tagName;"keydown"!==d.type||("INPUT"===c||"TEXTAREA"===c)||(d.preventDefault(),
d=d.keyCode,(c=a.keys[d])&&(a.actions[c]=d))},!1);window.addEventListener("keyup",function(d){"keyup"===d.type&&(d.preventDefault(),(d=a.keys[d.keyCode])&&(a.actions[d]=0))},!1)}});define("input/mouse",[],function(){return function(a){var d=this;this.y=this.x=0;this.inputmap={mouse1:-1,mouse2:-3,wheelUp:-4,wheelDown:-5};a.addEventListener("mousemove",function(c){var b=a.getBoundingClientRect();d.x=c.clientX-b.left;d.y=c.clientY-b.top},!1)}});
define("util/preload",[],function(){function a(){this.batch=[];this.errorstate=!1}a.prototype.add=function(a,c,b){this.batch.push({file:a,tag:c,fnStore:b})};a.prototype.load=function(a,c,b){function f(b,f){return function(){i.errorstate||(h--,b.fnStore(f,b.tag),c(1-h/i.batch.length),0===h&&a())}}function g(){i.errorstate||(i.errorstate=!0,b())}var h=this.batch.length,i=this;c(0);for(var k=0;k<this.batch.length;k++){var l=this.batch[k],j=new Image;j.onload=f(l,j);j.onerror=g;j.src=l.file}};return a});
define("util/rnd",[],function(){var a=function(a,c){return a+Math.random()*(c-a+1)|0};return{rnd:a,fastRand:function(d,c,b){for(var f=[],b=b||1E4;0<b;b--)f.push(a(d,c));var g=0;return function(){g++;g===f.length&&(g=0);return f[g]}}}});
define("util/bitmap",[],function(){return{imageToRData:function(a){var d=a.width,c=a.height,b=document.createElement("canvas");b.height=c;b.width=d;b=b.getContext("2d");b.drawImage(a,0,0);a=b.getImageData(0,0,d,c).data;d=Array(a.length/4);for(c=0;c<d.length;c++)d[c]=a[4*c];return d}}});
define("util/debug",[],function(){return{debugText:function(a,d,c,b){a.fillStyle="black";a.font="bold 16px Arial";a.fillText(d,c+1,b);a.fillText(d,c-1,b);a.fillText(d,c,b+1);a.fillText(d,c,b-1);a.fillStyle="white";a.fillText(d,c,b)}}});define("util/url",[],function(){return{queryStringValue:function(a){return(a=RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(a[1].replace(/\+/g," "))}}});
define("util/all","util/preload util/rnd util/bitmap util/debug util/js util/url".split(" "),function(a,d,c,b,f,g){return{Preloader:a,rnd:d,js:f,debug:b,Bitmap:c,Url:g}});
define("map/tile",[],function(){function a(a,c,b,f,g,h,i,k,l){this.img=a;this.x=c;this.y=b;this.w=f;this.h=g;this.xoverdraw=h;this.yoverdraw=i;this.defaultProps=k||{};this.properties=l||{}}a.prototype.draw=function(a,c,b){a.drawImage(this.img,this.x,this.y,this.w,this.h,c-this.xoverdraw,b-this.yoverdraw,this.w,this.h)};a.prototype.getProperty=function(a){if(this.properties.hasOwnProperty(a))return this.properties[a];if(this.defaultProps.hasOwnProperty(a))return this.defaultProps[a]};return a});
define("map/staggered-isometric",["map/tile","util/bitmap","util/debug","util/js"],function(a,d,c){function b(a,b,c,d){this.data=a;this.hitTests=b;this.maxYOverdraw=this.maxXOverdraw=0;this.clientWidth=c;this.clientHeight=d;this.minxoffset=this.data.tilewidth/2;this.minyoffset=this.data.tileheight/2;this.maxxoffset=this.data.width*this.data.tilewidth-this.clientWidth;this.maxyoffset=this.data.height*(this.data.tileheight/2)-this.clientHeight;this.xoffset=this.minxoffset;this.yoffset=this.maxyoffset}
var f=c.debugText,g=[0,0];b.prototype.minOffsets=function(){return{minxoffset:this.data.tilewidth/2,minyoffset:this.data.tileheight/2,maxxoffset:this.data.width*this.data.tilewidth-this.clientWidth,maxyoffset:this.data.height*(this.data.tileheight/2)-this.clientHeight}};b.prototype.primePreloader=function(a){for(var b=this.data,c=this,f=function(a,b){b.image=a},g=0;g<b.tilesets.length;g++){var h=b.tilesets[g];a.add(h.image,h,f)}var f=function(a,i){if(a.width!==b.tilewidth||a.height!==b.tileheight)throw"Hit test image "+
i+" does not match map tile size";"hit"===i&&(c.hitTest=d.imageToRData(a))},m;for(m in this.hitTests)a.add(this.hitTests[m],m,f)};var h=function(a){if(void 0===a)return a;for(var b in a)"height"===b&&"string"===typeof a[b]&&(a[b]=parseInt(a[b],10));return a};b.prototype.resolveTiles=function(){var b,c,d,f,g,r=this.data;for(d=r.tilesets.length-1;0<=d;d--)f=r.tilesets[d],f.xspan=Math.floor(f.imagewidth/f.tilewidth),f.yspan=Math.floor(f.imageheight/f.tileheight);for(b=0;b<r.layers.length;b++){var m=
r.layers[b];m.rows=[];var p=[];for(c=0;c<m.data.length;c++){var n=m.data[c];if(0===n)p.push(null);else{for(d=r.tilesets.length-1;0<=d&&!(f=r.tilesets[d],f.firstgid<=n);d--);d=n-f.firstgid;var n=Math.floor(d/f.xspan),v=d-f.xspan*n;g=f.tileheight-r.tileheight;this.maxXOverdraw=Math.max(f.tilewidth-r.tilewidth,this.maxXOverdraw);this.maxYOverdraw=Math.max(g,this.maxYOverdraw);g=void 0;void 0!==f.tileproperties&&f.tileproperties.hasOwnProperty(d)&&(g=f.tileproperties[d]);p.push(new a(f.image,v*f.tilewidth,
n*f.tileheight,f.tilewidth,f.tileheight,f.tilewidth-r.tilewidth,f.tileheight-r.tileheight,h(f.properties),h(g)))}p.length>=m.width&&(m.rows.push(p),p=[])}}};b.prototype.drawDebugRegions=function(a){var b=this.data,c,d,g,h,m,p,n=b.tilewidth,v=b.tileheight/2;m=Math.floor((this.yoffset-v)/v);d=Math.floor((this.yoffset+this.clientHeight-v+this.maxYOverdraw)/v)+1;g=Math.floor((this.xoffset+this.clientWidth-1)/n);p=Math.floor((this.xoffset-n/2-this.maxXOverdraw)/n);c=b.layers[0];c=Math.min(d,c.rows.length-
1);for(d=Math.max(p,0);m<=c;m++){var w;m&1?(p=b.tilewidth/2,w="#f00"):(p=0,w="#0f0");for(h=g;h>=d;h--){a.strokeStyle=w;var e=Math.floor(-this.xoffset)+p+h*n,s=Math.floor(-this.yoffset)+m*v,t=b.tilewidth,u=b.tileheight;a.strokeRect(e,s,t,u);a.strokeStyle="#aaa";a.beginPath();a.moveTo(e,s+u/2);a.lineTo(e+t/2,s);a.lineTo(e+t,s+u/2);a.lineTo(e+t/2,s+u);a.closePath();a.stroke()}}c=b.layers[0];for(m=0;m<c.rows.length;m++){g=c.rows[m];p=m&1?b.tilewidth/2:0;for(h=g.length-1;0<=h;h--)f(a,h+","+m,85+Math.floor(-this.xoffset)+
p+h*n,55+Math.floor(-this.yoffset)+m*v)}};b.prototype.scrollTo=function(a,b){this.xoffset=a;this.yoffset=b;this.xoffset<this.minxoffset?this.xoffset=this.minxoffset:this.xoffset>this.maxxoffset&&(this.xoffset=this.maxxoffset);this.yoffset<this.minyoffset?this.yoffset=this.minyoffset:this.yoffset>this.maxyoffset&&(this.yoffset=this.maxyoffset)};b.prototype.scroll=function(a,b){this.scrollTo(this.xoffset+a,this.yoffset+b)};b.prototype.getScreenEdges=function(){return{le:this.minxoffset,te:this.minyoffset,
re:this.maxxoffset+this.clientWidth,be:this.maxyoffset+this.clientHeight}};b.prototype.worldToTilePos=function(a,b,c){var d=this.data,f=d.tilewidth,d=d.tileheight,a=a|0,b=b|0;255!==this.hitTest[Math.floor(a%f)+Math.floor(b%d)*f]?(c[0]=((a+f)/f|0)-1,c[1]=2*(((b+d)/d|0)-1)):(c[0]=((a+f/2)/f|0)-1,c[1]=2*((b+d/2)/d|0)-1)};b.prototype.getTilePropAtWorldPos=function(a,b,c){this.worldToTilePos(b,c,g);for(var b=this.data.layers,d,c=b.length-1;0<=c;c--)if(d=b[c].rows,void 0!==d&&(0<=g[1]&&g[1]<d.length)&&
(d=d[g[1]][g[0]]))if(d=d.getProperty(a),void 0!==d)return d};b.prototype.screenToTilePos=function(a,b,c){this.worldToTilePos(a+this.xoffset,b+this.yoffset,c)};b.prototype.screenToWorldPos=function(a,b,c){c[0]=a+this.xoffset;c[1]=b+this.yoffset};b.prototype.worldToScreenPos=function(a,b,c){c[0]=a-this.xoffset;c[1]=b-this.yoffset};b.prototype.insertLayer=function(a,b){this.data.layers.splice(a,0,b)};b.prototype.updateLayers=function(a,b,c){a=this.data;for(b=0;b<a.layers.length;b++){var d=a.layers[b];
d.hasOwnProperty("update")&&d.update(c)}};b.prototype.drawWorld=function(a,b,c){var d=this.data,f=d.tilewidth,g=d.tileheight/2,h=Math.floor((this.yoffset-g)/g),p=Math.floor((this.yoffset+this.clientHeight-g+this.maxYOverdraw)/g)+1,n=Math.floor((this.xoffset+this.clientWidth-1)/f),v=Math.floor((this.xoffset-f/2-this.maxXOverdraw)/f);c.sort(function(a,b){var c=a.y-b.y;return 0!==c?c:a.h-b.h});var w=0,e=0,s,t,u,x,y,z,A,C=d.layers.length-1;for(y=0;y<d.layers.length;y++)if(x=d.layers[y],"draw"in x)x.draw(a,
b);else if(x.visible){z=Math.min(p,x.rows.length-1);A=Math.max(v,0);for(t=h;t<=z;t++){u=x.rows[t];e=t&1?d.tilewidth/2:0;for(s=n;s>=A;s--){var B=u[s];null!==B&&B.draw(a,Math.floor(-this.xoffset)+e+s*f,Math.floor(-this.yoffset)+t*g)}if(y==C)for(e=(t+2)*g;w<c.length&&e>=c[w].y;)c[w++].draw(a,this.xoffset,this.yoffset,b)}}};return b});
define("plugins/sprite/bounce",[],function(){function a(){}var d;a.prototype.update=function(){var a=this.sprite,b=a.state.jogPos(a.epoch,d.getNow()),b=2*b-1,b=b*b;a.h=this.bounce_base+this.bounce_height*(1-b);return!0};a.prototype.init=function(){};return function(c){d=c;d.registerSpriteUpdater("bounce",a)}});
define("plugins/sprite/follow-mouse",[],function(){function a(){}var d=[0,0],c;a.prototype.update=function(){c.mouseWorldPos(d);var a=this.sprite;a.x=d[0];a.y=d[1];return!0};a.prototype.init=function(){};return function(b){c=b;c.registerSpriteUpdater("follow_mouse",a)}});
define("plugins/sprite/link",[],function(){function a(){}var d;a.prototype.update=function(){for(var a=this.sprite,b=this.link_to.length-1;0<=b;b--)this.link_to[b].sprite.x=a.x+this.link_to[b].x,this.link_to[b].sprite.y=a.y+this.link_to[b].y;return!0};a.prototype.init=function(){if("object"!==typeof this.link_to)throw"Link plugin requires a link_to option value (array)";for(var a=this.link_to.length-1;0<=a;a--)this.link_to[a].sprite=d.spriteMap[this.link_to[a].name]};return function(c){d=c;d.registerSpriteUpdater("link",
a)}});
define("plugins/sprite/animate",[],function(){function a(){}var d;a.prototype.update=function(a){var b=this.sprite,a=a-this.epoch,d;for(d in this.props)b[d]=this.tweenfn(a,this.begin[d],this.props[d],this.duration);return!0};a.prototype.init=function(){var a=this.sprite;void 0===this.duration&&(this.duration=a.maxDuration());this.begin={};for(var b in this.props)this.begin[b]=a[b];this.duration=Math.max(this.duration,1);if(!d.tweens.hasOwnProperty(this.tween))throw"Unrecognized tween in animate plugin: "+this.tween;
this.tweenfn=d.tweens[this.tween];this.epoch=d.getNow()};return function(c){d=c;d.registerSpriteUpdater("animate",a)}});
define("plugins/sprite/8way",[],function(){function a(){}var d;a.prototype.update=function(){var a=this.sprite,b=a.directionx-a.x,d=2*(a.directiony-a.y);if(0===d)b=0===b?this.direction:0<b?"e":"w";else var g=b/d,b=0<=g?0.41421>g?0<d?"s":"n":2.4142<g?0<b?"e":"w":0<b?"se":"nw":-0.41421<g?0<d?"s":"n":-2.4142>g?0<b?"e":"w":0<b?"ne":"sw";this.direction=b;this.oldx=a.x;this.oldy=a.y;a.setState(a.stateName,this.direction);return!0};a.prototype.init=function(){this.direction="e"};return function(c){d=c;d.registerSpriteUpdater("8way",
a)}});define("plugins/layer/ui-layer",[],function(){function a(a,b){this.opts=b||{};this.name=a}var d;a.prototype.update=function(){};a.prototype.draw=function(){};return function(c){d=c;d.registerLayerPlugin("ui-layer",a,function(){})}});
define("plugins/layer/occlusion-scan",["util/js"],function(a){function d(a,c){this.opts=c||{};this.name=a;this.x=c.x;this.y=c.y;this.collider=b.createCollider("circle-trace",{radius:c.radius})}var c=a.copyProps,b;d.prototype.update=function(){};d.prototype.draw=function(a){var c=[0,0],d=[0,0],i=[0,0],k,l,j;for(k=-200;200>k;k+=8)a.lineWidth=1,a.strokeStyle="yellow",a.beginPath(),b.mouseWorldPos(c),l=c[0]+k-this.x,j=c[1]-this.y,l=this.collider.test(Math.floor(this.x),Math.floor(this.y),Math.floor(l),
Math.floor(j),0,i),b.worldToScreenPos(i[0],i[1],i),b.worldToScreenPos(this.x,this.y,d),a.moveTo(d[0],d[1]),a.lineTo(i[0],i[1]),a.stroke(),a.beginPath(),a.strokeStyle=1>l?"red":"green",a.arc(i[0],i[1],2.5,0,2*Math.PI),a.stroke();for(k=-200;200>k;k+=8)a.lineWidth=1,a.strokeStyle="yellow",a.beginPath(),b.mouseWorldPos(c),l=c[0]-this.x,j=c[1]+k-this.y,l=this.collider.test(Math.floor(this.x),Math.floor(this.y),Math.floor(l),Math.floor(j),0,i),b.worldToScreenPos(i[0],i[1],i),b.worldToScreenPos(this.x,this.y,
d),a.moveTo(d[0],d[1]),a.lineTo(i[0],i[1]),a.stroke(),a.beginPath(),a.strokeStyle=1>l?"red":"green",a.arc(i[0],i[1],2.5,0,2*Math.PI),a.stroke()};d.prototype.set=function(a){c(a,this)};return function(a){b=a;b.registerLayerPlugin("occlusion-scan",d,function(){})}});
define("plugins/fx/particles",["sprites/sprite","sprites/composite","util/rnd"],function(a,d,c){function b(a){this.opts=a;var b="number"===typeof a.number?a.number:a.number(),c="function"===typeof a.x?a.x():a.x,d="function"===typeof a.y?a.y():a.y;this.duration="function"===typeof a.duration?a.duration():a.duration;this.epoch=f.getNow();this.endCallback=a.endCallback;for(this.comp=f.createComposite(c,d,a.name);0<b--;)c=a.spritePos||{x:0,y:0,h:0},this.comp.addSprite(a.def,a.state,c.x||0,c.y||0,c.h||
0,a.spriteOpts).particleData={xspeed:g(-400,400)/1E3,hspeed:g(-600,50)/1E3,xaccell:0,haccell:0.001,startx:c.x||0,starth:c.h||0,epoch:this.epoch}}var f,g=c.rnd,h=function(a,b){var c=a.particleData,d=b-c.epoch,f=d*d;a.x=Math.floor(c.startx+(c.xspeed*d+c.xaccell*f/2));a.h=Math.floor(c.starth-(c.hspeed*d+c.haccell*f/2));0>a.h&&(a.h=0)};b.prototype.update=function(a){this.comp.update(a,h.bind(this));if(void 0!==this.duration&&a-this.epoch>this.duration)return void 0!==this.endCallback&&this.endCallback(),
!1;a=this.comp.isActive();!a&&void 0!==this.endCallback&&this.endCallback();return a};return function(a){f=a;f.registerFxPlugin("particles",b)}});define("plugins/camera/push-cam",[],function(){function a(a){this.follow=d.sprite(a.follow);if(!this.follow)throw"Camera can't follow missing sprite: "+a.follow;}var d;a.prototype.update=function(){d.scrollTo(this.follow.x-d.clientWidth/2,this.follow.y-d.clientHeight/2)};return function(c){d=c;d.registerCameraPlugin("pushcam",a,function(){})}});
define("plugins/collision/lib/prop-scanner",[],function(){return function(a,d,c,b,f,g,h,i,k){var l=b,j=f,q=g,r=h,m,p=b+g|0,n=f+h|0,b=b|0,f=f|0,g=Math.abs(p-b),h=Math.abs(n-f);if(0===g&&0===h)return k[0]=b,k[1]=f,a.getTilePropAtWorldPos(d,b,f),1;var v=b<p?1:-1,w=f<n?1:-1,e=g-h,s=!1,t=b,u=f;m=2*e;m>-h&&(e-=h,b+=v);m<g&&(e+=g,f+=w);for(;;){if(b<c.le||b>c.re||f<c.te||f>c.be){s=!0;break}m=a.getTilePropAtWorldPos(d,b,f);if(m>i){s=!0;break}t=b;u=f;if(b===p&&f===n)break;m=2*e;m>-h&&(e-=h,b+=v);m<g&&(e+=g,
f+=w)}s?void 0!==k&&(k[0]=t,k[1]=u):void 0!==k&&(k[0]=l+q,k[1]=j+r);return!s?1:g>h?(k[0]-l)/q:(k[1]-j)/r}});
define("plugins/collision/lib/local-scanner",[],function(){var a=function(a,c,b,f,g){var h=a.getTilePropAtWorldPos(f,c+1,b+1)>g,h=h<<1|a.getTilePropAtWorldPos(f,c,b+1)>g,h=h<<1|a.getTilePropAtWorldPos(f,c-1,b+1)>g,h=h<<1|a.getTilePropAtWorldPos(f,c+1,b)>g,h=h<<1|a.getTilePropAtWorldPos(f,c-1,b)>g,h=h<<1|a.getTilePropAtWorldPos(f,c+1,b-1)>g,h=h<<1|a.getTilePropAtWorldPos(f,c,b-1)>g;return h=h<<1|a.getTilePropAtWorldPos(f,c-1,b-1)>g};return{localScan:a,ySlip:function(d,c,b,f,g,h){g/=h;if(2<=g&&3>=g){d=
a(d,c,b,"height",f);if(23===d)return 1;if(232===d)return-1}else if(-2>=g&&-3<=g){d=a(d,c,b,"height",f);if(240===d)return-1;if(15===d)return 1}return 0}}});
define("plugins/collision/sprite-with-map/line-trace",["plugins/collision/lib/prop-scanner","plugins/collision/lib/local-scanner"],function(a,d){function c(a){a=a||{};this.sn=b;this.edges=b.getScreenEdges();this.autoSlip=void 0===a.autoSlip?!0:a.autoSlip}var b,f=d.ySlip;c.prototype.test=function(c,d,i,k,l,j){this.autoSlip&&(d+=f(b,c,d,l,i,k));return a(b,"height",this.edges,c,d,i,k,l,j)};return function(a){b=a;b.registerColliderPlugin("line-trace",c,function(){})}});
define("plugins/collision/lib/circle",[],function(){return function(a){for(var d=0,c=a,a=3-2*a,b=[];c>=d;)b.push(-d,-c,-c,-d,c,-d,d,-c,-d,c,-c,d,c,d,d,c),a=0>a?a+(4*d++ +6):a+(4*(d++-c--)+10);return b}});
define("plugins/collision/sprite-with-map/circle-trace",["plugins/collision/lib/prop-scanner","plugins/collision/lib/circle","plugins/collision/lib/local-scanner"],function(a,d,c){function b(a){a=a||{};this.sn=f;if(void 0===a.radius||0===a.radius)throw"Circle trace requires a radius >0 in its options.";this.edges=f.getScreenEdges();this.samples=d(a.radius|0);console.log("Circle has "+this.samples.length/2+" samples");this.lineHit=[0,0];this.autoSlip=void 0===a.autoSlip?!0:a.autoSlip}var f,g=c.ySlip;
b.prototype.test=function(b,c,d,l,j,q){this.autoSlip&&(c+=g(f,b,c,j,d,l));b=a(f,"height",this.edges,b,c,d,l,j,this.lineHit);q[0]=this.lineHit[0];q[1]=this.lineHit[1];return b};return function(a){f=a;f.registerColliderPlugin("circle-trace",b,function(){})}});
define("plugins/default-plugins","plugins/sprite/bounce plugins/sprite/follow-mouse plugins/sprite/link plugins/sprite/animate plugins/sprite/8way plugins/layer/ui-layer plugins/layer/occlusion-scan plugins/fx/particles plugins/camera/push-cam plugins/collision/sprite-with-map/line-trace plugins/collision/sprite-with-map/circle-trace".split(" "),function(a,d,c,b,f,g,h,i,k,l,j){return function(q){a(q);d(q);c(q);b(q);f(q);g(q);h(q);i(q);k(q);l(q);j(q)}});
define("animate/tween",[],function(){return{linear:function(a,d,c,b){return d+c*Math.min(1,a/b)},easeInOutCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-2*b*a+3*b)},easeInOutQuintic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;a*=b;return d+c*(6*a*b+-15*b*b+10*a)},easeInQuintic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*b*a*b},easeInQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*b*b},easeInCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a*a;return d+
c*b},easeInQuadratic:function(a,d,c,b){a=Math.min(b,a);return d+c*(a*a/b)},easeOutQuintic:function(a,d,c,b){var a=Math.min(b,a),b=(a/=b)*a,f=b*a;return d+c*(f*b+-5*b*b+10*f+-10*b+5*a)},easeOutQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-1*b*b+4*b*a+-6*b+4*a)},easeOutCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(b*a+-3*b+3*a)},easeOutInCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(4*b*a+-6*b+3*a)},backInCubic:function(a,d,c,b){a=Math.min(b,a);
b=(a/=b)*a;return d+c*(4*b*a+-3*b)},backInQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(2*b*b+2*b*a+-3*b)},outBackCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(4*b*a+-9*b+6*a)},outBackQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-2*b*b+10*b*a+-15*b+8*a)},bounceOut:function(a,d,c,b){var a=Math.min(b,a),b=(a/=b)*a,f=b*a;return d+c*(33*f*b+-106*b*b+126*f+-67*b+15*a)},bounceIn:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;a*=b;return d+c*(33*a*b+
-59*b*b+32*a+-5*b)}}});
define("polyfills/requestAnimationFrame",[],function(){for(var a=0,d=["ms","moz","webkit","o"],c=0;c<d.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[d[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[d[c]+"CancelAnimationFrame"]||window[d[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),h=window.setTimeout(function(){b(c+d)},d);a=c+d;return h});window.cancelAnimationFrame||
(window.cancelAnimationFrame=function(a){clearTimeout(a)})});
define("snaps","sprites/spritedef sprites/sprite sprites/composite input/keyboard input/mouse util/all map/staggered-isometric plugins/default-plugins animate/tween polyfills/requestAnimationFrame".split(" "),function(a,d,c,b,f,g,h,i,k){function l(p,n,l){function w(a){window.requestAnimationFrame(w);e.now=a;var b=a-e.lastFrameTime;e.updateFX(a);e.map.updateLayers(b);t(b);e.camera&&e.camera.update(b);s(e.ctx);e.dbgShowRegions&&void 0!==e.map&&e.map.drawDebugRegions(e.ctx);e.dbgShowMouse&&(j(e.ctx,
"Screen: "+e.mouse.x+","+e.mouse.y,5,15),j(e.ctx,"World: "+(e.mouse.x+e.map.xoffset)+","+(e.mouse.y+e.map.yoffset),5,30),j(e.ctx,"Origin: "+e.map.xoffset+","+e.map.yoffset,5,45));e.dbgShowCounts&&j(e.ctx,"Sprites: "+e.spriteCount(),5,e.clientHeight-15);e.dbgShowMouseTile&&void 0!==e.map&&(a=[0,0],e.mouseWorldPos(a),b=[0,0],e.worldToTilePos(a[0],a[1],b),j(e.ctx,"Mouse in tile: "+b[0]+", "+b[1],5,e.clientHeight-30));e.lastFrameTime=e.now}var e=this;this.util=g;this.tweens=k;this.dbgShowMouse=!!l.showMouse;
this.dbgShowCounts=!!l.showCounts;this.dbgShowRegions=!!l.showRegions;this.dbgShowMouseTile=!!l.showMouseTile;this.imageCache={};this.spriteUpdaters={};this.colliders={};this.fxUpdaters={};this.layerPlugins={};this.cameraPlugins={};this.timers={};this.cameras={};this.camera=null;this.activeFX=[];e.now=0;n=document.getElementById(n);this.clientWidth=n.clientWidth;this.clientHeight=n.clientHeight;this.ctx=n.getContext("2d");this.keyboard=new b;this.mouse=new f(n);this.ctx.fillStyle="#000022";this.ctx.fillRect(0,
0,n.clientWidth,n.clientHeight);this.game=p;if(void 0!==p.map){if("object"!==typeof p.hitTests||void 0===p.hitTests.hit)throw"Game must define a hitTests object with at least a 'hit' property";this.map=new h(p.map,p.hitTests,this.clientWidth,this.clientHeight)}var s=e.game.draw,t=e.game.update;this.spriteDefs={};this.sprites=[];this.spriteMap={};this.lastFrameTime=0;this.registerSpriteUpdater=function(a,b){e.spriteUpdaters[a]=b};this.registerFxPlugin=function(a,b){e.fxUpdaters[a]=b};this.registerLayerPlugin=
function(a,b,c){c.call(this);e.layerPlugins[a]=b};this.registerColliderPlugin=function(a,b,c){e.colliders[a]={fn:b,init:c}};this.registerCameraPlugin=function(a,b,c){e.cameraPlugins[a]={fn:b,init:c}};i(this);if("function"===typeof e.game.onEngineStart)e.game.onEngineStart(this);n=new m;void 0!==this.map&&this.map.primePreloader(n);if("object"===typeof p.preloadImages){var l=function(a,b){e.imageCache[b]=a},u;for(u in p.preloadImages)n.add(p.preloadImages[u],u,l)}if("object"===typeof e.game.spriteDefs){var p=
function(b,c){var d=e.game.spriteDefs[c],f=new a(b,d.w,d.h,d.x,d.y);e.spriteDefs[c]=f;for(var g in d.states)f.addState(g,d.states[g].seq,d.states[g].dur)},x;for(x in e.game.spriteDefs)n.add(e.game.spriteDefs[x].path,x,p)}this.drawImage=function(a,b,c){e.ctx.drawImage(e.imageCache[a],b,c)};this.cls=function(a){e.ctx.fillStyle=a||"#000";e.ctx.fillRect(0,0,e.clientWidth,e.clientHeight)};this.bindKeys=function(a){for(var b=0;b<a.length;b++){var c=a[b];e.keyboard.bind(c.key,c.action)}};this.updateFX=function(a){for(var b=
e.activeFX.length-1;0<=b;b--)e.activeFX[b].update(a)||e.activeFX.splice(b,1)};this.fx=function(a,b){if(!e.fxUpdaters.hasOwnProperty(a))throw"Can't spawn FX for unregistered FX type: "+a;e.activeFX.push(new e.fxUpdaters[a](b))};this.addLayer=function(a,b,c,d){if(!e.layerPlugins.hasOwnProperty(b))throw"Can't spawn layer for unregistered layer type: "+b;a=new e.layerPlugins[b](a,c);e.map.insertLayer(d,a);return a};this.spriteCount=function(){for(var a=0,b=0;b<e.sprites.length;b++){var d=e.sprites[b];
d instanceof c?a+=d.sprites.length:a++}return a};n.load(function(){void 0!==e.map&&e.map.resolveTiles();if("function"===typeof e.game.onResourcesLoaded)e.game.onResourcesLoaded();setTimeout(function(){w(0)},0)},function(a){if("function"===typeof e.game.onProgress)e.game.onProgress(a,e.ctx)},function(){e.game.onLoadError()});this.actioning=function(a){return e.keyboard.actionPressed(a)};this.scroll=function(a,b){e.map.scroll(a,b)};this.scrollTo=function(a,b){e.map.scrollTo(a,b)};this.getScreenEdges=
function(){return e.map.getScreenEdges()};this.drawWorld=function(){this.map.drawWorld(e.ctx,e.now,e.sprites)};this.drawSpriteWorld=function(a){e.spriteMap[a].draw(e.ctx,e.map.xoffset,e.map.yoffset,e.now)};this.mouseScreenPos=function(a){a[0]=e.mouse.x;a[1]=e.mouse.y};this.mouseWorldPos=function(a){e.map.screenToWorldPos(e.mouse.x,e.mouse.y,a)};this.worldToTilePos=function(a,b,c){this.map.worldToTilePos(a,b,c)};this.screenToTilePos=function(a,b,c){this.map.screenToTilePos(a,b,c)};this.screenToWorldPos=
function(a,b,c){this.map.screenToWorldPos(a,b,c)};this.worldToScreenPos=function(a,b,c){this.map.worldToScreenPos(a,b,c)};this.getTilePropAtWorldPos=function(a,b,c){return this.map.getTilePropAtWorldPos(a,b,c)};this.createCollider=function(a,b){if(!e.colliders.hasOwnProperty(a))throw"Warning: undefined collider plugin: "+a;return new e.colliders[a].fn(b)};this.createCamera=function(a,b,c){if(!e.cameraPlugins.hasOwnProperty(b))throw"Warning: undefined camera plugin: "+b;if(this.cameras.hasOwnProperty(a))throw"Camera already exists: "+
a;this.cameras[a]=new e.cameraPlugins[b].fn(c);return this.cameras[a]};this.switchToCamera=function(a){this.camera=this.cameras[a]};this.nextName=1;this.spawnSprite=function(a,b,c,f,g,h,i){void 0===i&&(i={});var j=i.name;if(void 0===j)j="unnamed"+e.nextName,e.nextName++;else if(e.spriteMap.hasOwnProperty(j))throw"Error: duplicate sprite name "+j;if(!e.spriteDefs.hasOwnProperty(a))throw"Error: Missing sprite definition when spawning sprite "+a;var a=e.spriteDefs[a],k=i.updates;if(void 0!==k)for(var k=
Array(i.updates.length),l=0;l<i.updates.length;l++){var m=i.updates[l].name;if(!e.spriteUpdaters.hasOwnProperty(m))throw"Sprite plugin used but not registered: "+m;k[l]=new e.spriteUpdaters[m];q(i.updates[l],k[l])}i=r(i);i.updates=k;f=new d(e,a,f,g,h,i);f.setState(b,c);if(void 0!==i.opts)for(var n in i.opts)f[n]=i.opts[n];f.init();e.sprites.push(f);e.spriteMap[j]=f};this.createComposite=function(a,b,d,f){if(void 0===d)d="unnamed"+e.nextName,e.nextName++;else if(e.spriteMap.hasOwnProperty(d))throw"Warning: duplicate sprite (composite) name "+
d;a=new c(this,a,b,f);a.init();e.sprites.push(a);return e.spriteMap[d]=a};this.markTime=function(a,b){e.timers[a]=e.now+b};this.checkTimer=function(a,b){if(void 0===e.timers[a])return!1;var c=e.timers[a];if(0<e.now-c){if(void 0===b)delete e.timers[a];else{b=Math.max(1,b);do c+=b;while(c<e.now);e.timers[a]=c}return!0}return!1};this.sprite=function(a){return e.spriteMap[a]};this.updateSprites=function(){for(var a=[],b=0;b<e.sprites.length;b++){var c=e.sprites[b];c.isActive(e.now)?(c.update(e.now),a.push(c)):
delete e.spriteMap[c.name]}e.sprites=a};this.getNow=function(){return e.now};this.resizeCanvas=function(){}}var j=g.debug.debugText,q=g.js.copyProps,r=g.js.clone,m=g.Preloader;l.util=g;return l});
