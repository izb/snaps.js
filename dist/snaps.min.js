define("sprites/spritedef",[],function(){function a(c,b,a){this.seq=c;this.dur=b;this.def=a}function d(c,b,a,l,d){this.states={};this.image=c;this.w=b;this.h=a;this.x=l;this.y=d}a.prototype.jogPos=function(c,b){var a;a=(b-c)%this.dur;return a/this.dur};a.prototype.draw=function(c,b,a,l,d,h){var k=this.def;l=this.seq[h?this.seq.length-1:Math.floor(this.seq.length*this.jogPos(l,d))];c.drawImage(k.image,l[0],l[1],k.w,k.h,b,a,k.w,k.h)};d.prototype.addState=function(c,b,d){for(var l=[],f=Math.floor(this.image.width/
this.w),h=0;h<b.length;h++){var k=b[h];l.push([this.w*(k%f),this.h*Math.floor(k/f)])}this.states[c]=new a(l,d,this)};d.prototype.aliasState=function(c,b){this.states[c]=this.states[b]};return d});
define("util/js",[],function(){HTMLCanvasElement.prototype.relCoords=function(a,d,c){var b=this.getBoundingClientRect();c[0]=a-b.left-window.pageXOffset;c[1]=d-b.top-window.pageYOffset};return{copyProps:function(a,d){for(var c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);return d},clone:function(a){var d={},c;for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);return d}}});
define("sprites/sprite",["util/js"],function(a){function d(b,c,a,k,d,e){e=e||{};this.def=c;this.sn=b;this.x="function"===typeof a?a():a;this.y="function"===typeof k?k():k;this.h="function"===typeof d?d():d;this.state=null;this.active=!0;this.maxloops=void 0===e.maxloops?0:"function"===typeof e.maxloops?e.maxloops():e.maxloops;this.updates=e.updates;this.commits=e.commits;this.id=e.id;"number"===typeof this.id?(this.nuid=this.id,this.id="id"+this.id):this.nuid=b.util.uid();this.endCallback=e.endCallback;
this.collider=e.collider;this.autoRemove=e.autoRemove;void 0===this.autoRemove&&(this.autoRemove=!0);this.collisionPoint=[0,0];this.quantizedHeight=!!e.quantizedHeight;this.directionNormalized=!1;this.vectorx=0;this.vectory=1;this.directionx=a;this.directiony=k+1;this.velocityy=this.velocityx=0}var c=a.copyProps,b=a.clone;d.prototype.init=function(){var b;if(void 0!==this.updates)for(b=0;b<this.updates.length;b++){var c=this.updates[b];c.init(this);c.hasOwnProperty("phaser")&&c.phaser.addSprite(this)}if(void 0!==
this.commits)for(b=0;b<this.commits.length;b++)c=this.commits[b],c.init(this),c.hasOwnProperty("phaser")&&c.phaser.addSprite(this)};d.prototype.maxDuration=function(){return 0===this.maxloops?0:this.state.dur*this.maxloops};d.prototype.isActive=function(b){this.active&&(0<this.maxloops&&this.state.dur*this.maxloops<=b-this.epoch)&&(this.active=!1,void 0!==this.endCallback&&this.autoRemove&&this.endCallback());return this.active||!this.autoRemove};d.prototype.setState=function(b,c){this.active=!0;
if(!(this.stateName===b&&this.stateExt===c)){this.stateName=b;this.stateExt=c;void 0!==c&&this.def.states.hasOwnProperty(b+"_"+c)&&(b=b+"_"+c);if(!this.def.states.hasOwnProperty(b))throw"Bad sprite definition. Missing state: "+b;this.state=this.def.states[b];this.epoch=this.sn.getNow()}};d.prototype.stateName=function(){return this.stateName};d.prototype.hasState=function(b){return this.def.states.hasOwnProperty(b)};d.prototype.morphState=function(b,c){};d.prototype.update=function(b){if(void 0!==
this.updates)for(var c=0;c<this.updates.length;c++){var a=this.updates[c];if(a.predicate.call(this)){var k=void 0===a.phaser?!0:a.phaser.phase(this,b);if(!a.update(b,k))break}}};d.prototype.commit=function(b){if(void 0!==this.commits)for(var c=0;c<this.commits.length;c++){var a=this.commits[c];if(a.predicate.call(this)){var k=void 0===a.phaser?!0:a.phaser.phase(this,b);if(!a.update(b,k))break}}};d.prototype.drawAt=function(b,c,a,k){(this.active||!this.autoRemove)&&this.state.draw(b,c,a,this.epoch,
k,!this.active&&!this.autoRemove)};d.prototype.moveTo=function(b,c,a,k){void 0!==a&&(a-=this.h);return this.move(b-this.x,c-this.y,a,k)};d.prototype.move=function(b,c,a,k){if(!b&&!c&&!a)return!1;k=void 0===k?!0:k;var e;k&&void 0!==this.collider?(e=this.collider.test(this.x,this.y,b,c,this.h,this.collisionPoint),this.x=this.collisionPoint[0],this.y=this.collisionPoint[1]):(this.x+=b,this.y+=c);this.setDirection(this.x+b,this.y+c);b=k&&1>e;if(void 0!==a){if(b&&!this.quantizedHeight)return this.h+=a*
e,!0;this.h+=a;return!1}return b};d.prototype.setDirection=function(b,c){this.directionx=b;this.directiony=c;this.directionNormalized=!1};d.prototype.vector=function(b){if(!this.directionNormalized){this.directionNormalized=!0;var c=this.directionx-this.x,a=this.directiony-this.y;if(0===c&&0===a)this.vectory=this.vectorx=0;else{var k=Math.sqrt(c*c+a*a);this.vectorx=c/k;this.vectory=a/k}}b[0]=this.vectorx;b[1]=this.vectory};d.prototype.vectorTo=function(b,c,a){b-=this.x;c-=this.y;if(0===b&&0===c)a[0]=
0,a[1]=0;else{var k=Math.sqrt(b*b+c*c);a[0]=b/k;a[1]=c/k}};d.prototype.draw=function(b,c,a,k){this.drawAt(b,this.x-c-this.def.x|0,this.y-a-this.def.y-this.h|0,k)};d.prototype.onRemove=function(){if(void 0!==this.updates)for(var b=0;b<this.updates.length;b++){var c=this.updates[b];void 0!==c.phaser&&c.phaser.removeSprite(this);c.onSpriteRemoved()}};var e=function(){return!0};d.construct=function(a,f,h,k,q,m,p,n){if(!a.spriteDefs.hasOwnProperty(f))throw"Error: Missing sprite definition when spawning sprite "+
f;var r=a.spriteDefs[f],s=function(b){var c=typeof b.predicate;if("string"===c){var a=b.predicate;return function(){return x.stateName===a}}if("object"===c){for(var k={},c=b.predicate.length-1;0<=c;c--)k[b.predicate[c]]=!0;return function(){return k.hasOwnProperty(x.stateName)}}return"function"===c?b.predicate:e},u=n.updates;if(void 0!==u){u=Array(n.updates.length);for(f=0;f<n.updates.length;f++){var v=n.updates[f],w=v.name;if(!a.spriteUpdaters.hasOwnProperty(w))throw"Sprite plugin not registered: "+
w;u[f]=new a.spriteUpdaters[w];c(v,u[f]);u[f].predicate=s(v)}}v=n.commits;if(void 0!==v){v=Array(n.commits.length);for(f=0;f<n.commits.length;f++){var w=n.commits[f],y=w.name;if(!a.spriteUpdaters.hasOwnProperty(y))throw"Sprite plugin not registered: "+y;v[f]=new a.spriteUpdaters[y];c(w,v[f]);v[f].predicate=s(w)}}n=b(n);n.updates=u;n.commits=v;var x=new d(a,r,q,m,p,n);x.setState(h,k);if(void 0!==n.opts)for(var t in n.opts)x[t]=n.opts[t];x.init();return x};return d});
define("sprites/composite",["util/js","sprites/sprite"],function(a,d){function c(b,c,a,k,e){this.sn=b;this.x=c;this.y=a;this.endCallback=e;this.active=!0;this.sprites=[]}var b=a.copyProps,e=a.clone;c.prototype.init=function(){};c.prototype.addSprite=function(c,a,h,k,q,m){void 0===m&&(m={});c=this.sn.spriteDefs[c];var p=m.updates;if(void 0!==p)for(var p=Array(m.updates.length),n=0;n<m.updates.length;n++)p[n]=new this.sn.spriteUpdaters[m.updates[n].name],b(m.updates[n],p[n]);m=e(m);m.updates=p;h=new d(this.sn,
c,h,k,q,m);h.setState(a);if(void 0!==m.opts)for(var r in m.opts)h[r]=m.opts[r];h.init();this.sprites.push(h);return h};c.prototype.isActive=function(b){if(!this.active)return!1;for(var c=!1,a=this.sprites.length-1;0<=a;a--)this.sprites[a].isActive(b)?c=!0:this.sprites.splice(a,1);this.active=c;!this.active&&void 0!==this.endCallback&&this.endCallback();return c};c.prototype.update=function(b,c){for(var a=this.sprites.length-1;0<=a;a--)void 0!==c&&c(this.sprites[a],b),this.sprites[a].update()};c.prototype.draw=
function(b,c,a,k){if(this.active){c=this.x-c;a=this.y-a;for(var e=0;e<this.sprites.length;e++){var d=this.sprites[e];d.isActive(k)&&d.drawAt(b,c+d.x-d.def.y,a+d.y-d.h-d.def.y,k)}}};c.prototype.onRemove=function(){for(var b=this.sprites.length-1;0<=b;b--)this.sprites[b].onRemove()};return c});
define("input/keyboard",[],function(){return function(){var a=this;this.keymap={backspace:8,tab:9,enter:13,pause:19,capsLock:20,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46,plus:187,comma:188,minus:189,period:190,shift:16,ctrl:17,alt:18,zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,
num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,multiply:106,add:107,substract:109,decimal:110,divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};this.actions=[];this.keys=[];this.bind=function(d,c){a.actions[c]=0;a.keys[a.keymap[d]]=c};this.actionPressed=function(d){return!!a.actions[d]};window.addEventListener("keydown",function(d){var c=d.target.tagName;"keydown"!==d.type||("INPUT"===c||"TEXTAREA"===c)||(d.preventDefault(),
d=d.keyCode,(c=a.keys[d])&&(a.actions[c]=d))},!1);window.addEventListener("keyup",function(d){"keyup"===d.type&&(d.preventDefault(),(d=a.keys[d.keyCode])&&(a.actions[d]=0))},!1)}});define("input/mouse",[],function(){return function(a){var d=this;this.y=this.x=0;this.inputmap={mouse1:-1,mouse2:-3,wheelUp:-4,wheelDown:-5};a.addEventListener("mousemove",function(c){var b=a.getBoundingClientRect();d.x=c.clientX-b.left;d.y=c.clientY-b.top},!1)}});
define("util/preload",[],function(){function a(){this.batch=[];this.errorstate=!1}a.prototype.add=function(a,c,b){this.batch.push({file:a,tag:c,fnStore:b})};a.prototype.load=function(a,c,b){function e(b,e){return function(){h.errorstate||(f--,void 0!==b.fnStore&&b.fnStore(e,b.tag),c(1-f/h.batch.length),0===f&&a())}}function l(c){h.errorstate||(h.errorstate=!0,b())}var f=this.batch.length,h=this;c(0);for(var k=0;k<this.batch.length;k++){var q=this.batch[k],m=new Image;m.onload=e(q,m);m.onerror=l;m.src=
q.file}};return a});define("util/rnd",[],function(){var a=function(b,c){return b+Math.random()*(c-b+1)|0},d=function(b,c){return b+Math.random()*(c-b+1)},c=function(b,c,a,d){var h=[];for(a=a||1E4;0<a;a--)h.push(d(b,c));var k=0;return function(){k++;k===h.length&&(k=0);return h[k]}};return{rnd:a,rndFloat:d,fastRand:function(b,e,d){return c(b,e,d,a)},fastRandFloat:function(b,a,l){return c(b,a,l,d)}}});
define("util/bitmap",[],function(){return{imageToRData:function(a){var d=a.width,c=a.height,b=document.createElement("canvas");b.height=c;b.width=d;b=b.getContext("2d");b.drawImage(a,0,0);a=b.getImageData(0,0,d,c).data;d=Array(a.length/4);for(c=0;c<d.length;c++)d[c]=a[4*c];return d}}});
define("util/debug",[],function(){return{debugText:function(a,d,c,b){a.fillStyle="black";a.font="bold 16px Arial";a.fillText(d,c+1,b);a.fillText(d,c-1,b);a.fillText(d,c,b+1);a.fillText(d,c,b-1);a.fillStyle="white";a.fillText(d,c,b)}}});
define("util/minheap",[],function(){function a(){this.heap=[];this.left=function(a){return 2*a+1};this.right=function(a){return 2*a+2};this.parent=function(a){return Math.ceil(a/2)-1};this.heapify=function(a){var c=this.left(a),b=this.right(a),c=c<this.heap.length&&this.heap[c].priority<this.heap[a].priority?c:a;b<this.heap.length&&this.heap[b].priority<this.heap[c].priority&&(c=b);a!==c&&(b=this.heap[c],this.heap[c]=this.heap[a],this.heap[a]=b,this.heapify(c))};this.siftUp=function(a){var c=this.parent(a);
if(0<=c&&this.heap[c].priority>this.heap[a].priority){var b=this.heap[c];this.heap[c]=this.heap[a];this.heap[a]=b;this.siftUp(c)}}}a.prototype.push=function(a){this.heap.push(a);this.siftUp(this.heap.length-1)};a.prototype.pop=function(){var a;1<this.heap.length?(a=this.heap[0],this.heap[0]=this.heap.pop(),this.heapify(0)):a=this.heap.pop();return a};a.prototype.peek=function(){return this.heap[0]};a.prototype.size=function(){return this.heap.length};a.prototype.clear=function(){this.heap.length=
0;return this};return a});define("util/stats",[],function(){function a(){this.samples={};this.totals={};this.averages={}}a.prototype.count=function(a,c){var b,e;this.samples.hasOwnProperty(a)?(e=this.totals[a],b=this.samples[a]):(b=[],e=0,this.samples[a]=b);b.push(c);e+=c;10<b.length&&(e-=b[0],b.splice(0,1));this.totals[a]=e;this.averages[a]=e/b.length};return a});define("util/uid",[],function(){var a=1;return function(){return a++}});
define("util/url",[],function(){return{queryStringValue:function(a){return(a=RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(a[1].replace(/\+/g," "))}}});define("util/all","util/preload util/rnd util/bitmap util/debug util/js util/minheap util/stats util/uid util/url".split(" "),function(a,d,c,b,e,l,f,h,k){return{Preloader:a,rnd:d,js:e,MinHeap:l,Stats:f,uid:h,debug:b,Bitmap:c,Url:k}});
define("map/tile",["util/uid"],function(a){function d(a,b,e,d,f,h,k,q,m){this.img=a;this.x=b;this.y=e;this.w=d;this.h=f;this.xoverdraw=h;this.yoverdraw=k;this.defaultProps=q||{};this.properties=m||{}}d.prototype.draw=function(a,b,e){a.drawImage(this.img,this.x,this.y,this.w,this.h,b-this.xoverdraw,e-this.yoverdraw,this.w,this.h)};d.prototype.getProperty=function(a){if(this.properties.hasOwnProperty(a))return this.properties[a];if(this.defaultProps.hasOwnProperty(a))return this.defaultProps[a]};return d});
define("map/staggered-isometric",["map/tile","util/bitmap","util/debug","util/js"],function(a,d,c,b){function e(b,a,c,e,d){this.data=b;this.hitTests=a;this.maxYOverdraw=this.maxXOverdraw=0;this.clientWidth=c;this.clientHeight=e;this.hideBuildings=!1;this.type=this.data.orientation;this.minxoffset=this.data.tilewidth/2;this.minyoffset=this.data.tileheight/2;this.maxxoffset=this.data.width*this.data.tilewidth-this.clientWidth-1;this.maxyoffset=this.data.height*(this.data.tileheight/2)-this.clientHeight-
1;this.xoffset=this.minxoffset;this.yoffset=this.maxyoffset;this.stats=d}var l=c.debugText,f=[0,0];e.prototype.isStaggered=function(){return"staggered"===this.type};e.prototype.isOrthogonal=function(){return"orthogonal"===this.type};e.prototype.tileDimensions=function(b){b[0]=this.data.tilewidth;b[1]=this.data.tileheight};e.prototype.primePreloader=function(b){for(var a=this.data,c=this,e=function(b,a){a.image=b},h=0;h<a.tilesets.length;h++){var l=a.tilesets[h];b.add(l.image,l,e)}var e=function(b,
e){if(b.width!==a.tilewidth||b.height!==a.tileheight)throw"Hit test image "+e+" does not match map tile size";"hit"===e&&(c.hitTest=d.imageToRData(b))},f;for(f in this.hitTests)b.add(this.hitTests[f],f,e)};var h=function(b){if(void 0===b)return b;for(var a in b)"height"===a&&"string"===typeof b[a]&&(b[a]=parseInt(b[a],10));return b};e.prototype.getTile=function(b,a,c){b=b.rows;if(0>a||0>c||c>=b.length)return null;c=b[c];return a>=c.length?null:c[a]};e.prototype.resolveTiles=function(){var b,c,e,d,
l,f=this.data;for(e=f.tilesets.length-1;0<=e;e--)d=f.tilesets[e],d.xspan=Math.floor(d.imagewidth/d.tilewidth),d.yspan=Math.floor(d.imageheight/d.tileheight);for(b=this.columns=this.rows=0;b<f.layers.length;b++){var s=f.layers[b];this.columns=Math.max(this.columns,s.width);s.rows=[];var u=[];for(c=0;c<s.data.length;c++){var v=s.data[c];if(0===v)u.push(null);else{for(e=f.tilesets.length-1;0<=e&&!(d=f.tilesets[e],d.firstgid<=v);e--);e=v-d.firstgid;var v=Math.floor(e/d.xspan),w=e-d.xspan*v;l=d.tileheight-
f.tileheight;this.maxXOverdraw=Math.max(d.tilewidth-f.tilewidth,this.maxXOverdraw);this.maxYOverdraw=Math.max(l,this.maxYOverdraw);l=void 0;void 0!==d.tileproperties&&d.tileproperties.hasOwnProperty(e)&&(l=d.tileproperties[e]);u.push(new a(d.image,w*d.tilewidth,v*d.tileheight,d.tilewidth,d.tileheight,d.tilewidth-f.tilewidth,d.tileheight-f.tileheight,h(d.properties),h(l)))}u.length>=s.width&&(s.rows.push(u),this.rows=Math.max(this.rows,u.length),u=[])}}};e.prototype.drawDebugRegions=function(b){var a=
this.data,c,e,d,h,f,u,v=a.tilewidth,w=a.tileheight/2;f=Math.floor((this.yoffset-w)/w);e=Math.floor((this.yoffset+this.clientHeight-w+this.maxYOverdraw)/w)+1;d=Math.floor((this.xoffset+this.clientWidth-1)/v);u=Math.floor((this.xoffset-v/2-this.maxXOverdraw)/v);c=a.layers[0];c=Math.min(e,c.rows.length-1);for(e=Math.max(u,0);f<=c;f++){u=f&1?a.tilewidth/2:0;for(h=d;h>=e;h--){var y=Math.floor(-this.xoffset)+u+h*v,x=Math.floor(-this.yoffset)+f*w,t=a.tilewidth,z=a.tileheight;b.strokeStyle="#aaa";b.beginPath();
b.moveTo(y,x+z/2);b.lineTo(y+t/2,x);b.lineTo(y+t,x+z/2);b.lineTo(y+t/2,x+z);b.closePath();b.stroke()}}c=a.layers[0];for(f=0;f<c.rows.length;f++){d=c.rows[f];u=f&1?a.tilewidth/2:0;for(h=d.length-1;0<=h;h--)l(b,h+","+f,85+Math.floor(-this.xoffset)+u+h*v,55+Math.floor(-this.yoffset)+f*w)}};e.prototype.scrollTo=function(b,a){this.xoffset=b;this.yoffset=a;this.xoffset<this.minxoffset?this.xoffset=this.minxoffset:this.xoffset>this.maxxoffset&&(this.xoffset=this.maxxoffset);this.yoffset<this.minyoffset?
this.yoffset=this.minyoffset:this.yoffset>this.maxyoffset&&(this.yoffset=this.maxyoffset)};e.prototype.scroll=function(b,a){this.scrollTo(this.xoffset+b,this.yoffset+a)};e.prototype.getWorldEdges=function(){return{le:this.minxoffset,te:this.minyoffset,re:this.maxxoffset+this.clientWidth,be:this.maxyoffset+this.clientHeight}};e.prototype.worldToTilePos=function(b,a,c){var e=this.data,d=e.tilewidth,e=e.tileheight;b|=0;a|=0;var h=this.hitTest[Math.floor(b%d)+Math.floor(a%e)*d];if(128<=h)return c[0]=
((b+d)/d|0)-1,c[1]=2*(((a+e)/e|0)-1),h-128;c[0]=((b+d/2)/d|0)-1;c[1]=2*((a+e/2)/e|0)-1;return h};e.prototype.getTilePropAtTilePos=function(b,a,c){for(var e=this.data.layers,d,h=e.length-1;0<=h;h--)if(d=e[h].rows,void 0!==d&&(0<=c&&c<d.length)&&(d=d[c][a]))if(d=d.getProperty(b),void 0!==d)return d};e.prototype.getTilePropAtWorldPos=function(b,a,c){this.worldToTilePos(a,c,f);return this.getTilePropAtTilePos(b,f[0],f[1])};e.prototype.screenToTilePos=function(b,a,c){return this.worldToTilePos(b+this.xoffset,
a+this.yoffset,c)};e.prototype.screenToWorldPos=function(b,a,c){c[0]=b+this.xoffset;c[1]=a+this.yoffset};e.prototype.worldToScreenPos=function(b,a,c){c[0]=b-this.xoffset;c[1]=a-this.yoffset};e.prototype.insertLayer=function(b,a){this.data.layers.splice(b,0,a)};e.prototype.updateLayers=function(b){for(var a=+new Date,c=this.data,e=0;e<c.layers.length;e++){var d=c.layers[e];d.hasOwnProperty("update")&&d.update(b)}this.stats.count("updateLayers",+new Date-a)};e.prototype.groundLayer=function(){for(var b=
this.data,a=0;a<b.layers.length;a++){var c=b.layers[a];if(!("draw"in c)&&c.visible)return c}};e.prototype.onResize=function(b,a){this.clientWidth=b;this.clientHeight=a;this.maxxoffset=this.data.width*this.data.tilewidth-this.clientWidth-1;this.maxyoffset=this.data.height*(this.data.tileheight/2)-this.clientHeight-1};e.prototype.drawWorld=function(b,a,c){var e=this.data,d,h=e.tilewidth,f=e.tileheight/2,l=Math.floor((this.yoffset-f)/f),v=Math.floor((this.yoffset+this.clientHeight-f+this.maxYOverdraw)/
f)+1,w=Math.floor((this.xoffset+this.clientWidth-1)/h),y=Math.floor((this.xoffset-h/2-this.maxXOverdraw)/h);d=+new Date;c.sort(function(b,a){var c=b.y-a.y;if(0!==c)return c;c=b.h-a.h;return 0!==c?c:b.nuid-a.nuid});this.stats.count("spriteSort",+new Date-d);d=+new Date;var x=0,t=0,z,g,A,D,E,G,H,B=e.layers.length-1;for(E=0;E<e.layers.length;E++){D=e.layers[E];var F=!this.hideBuildings||E!==B;if("draw"in D)D.draw(b,a);else if(D.visible){G=Math.min(v,D.rows.length-1);H=Math.max(y,0);for(g=l;g<=G;g++){A=
D.rows[g];t=g&1?e.tilewidth/2:0;for(z=w;z>=H;z--){var C=A[z];null!==C&&F&&C.draw(b,Math.floor(-this.xoffset)+t+z*h,Math.floor(-this.yoffset)+g*f)}if(E===B)for(t=(g+2)*f;x<c.length&&t>=c[x].y;)c[x++].draw(b,this.xoffset,this.yoffset,a)}}}this.stats.count("paintWorld",+new Date-d)};return e});
define("plugins/sprite/bounce",[],function(){function a(){}var d;a.prototype.update=function(a,b){var e=this.sprite,l=e.state.jogPos(e.epoch,d.getNow()),l=2*l-1,l=l*l;e.h=this.bounce_base+this.bounce_height*(1-l);return!0};a.prototype.init=function(a){this.sprite=a};a.prototype.onSpriteRemoved=function(){};return function(c){d=c;d.registerSpriteUpdater("bounce",a)}});
define("plugins/sprite/follow-mouse",[],function(){function a(){}var d=[0,0],c;a.prototype.update=function(b,a){c.mouseWorldPos(d);var l=this.sprite;l.x=d[0];l.y=d[1];return!0};a.prototype.init=function(b){this.sprite=b};a.prototype.onSpriteRemoved=function(){};return function(b){c=b;c.registerSpriteUpdater("follow_mouse",a)}});
define("plugins/sprite/animate",[],function(){function a(){}var d;a.prototype.update=function(a,b){var e=this.sprite,d=a-this.epoch,f;for(f in this.props)e[f]=this.tweenfn(d,this.begin[f],this.props[f],this.duration);return!0};a.prototype.init=function(a){this.sprite=a;void 0===this.duration&&(this.duration=a.maxDuration());this.begin={};for(var b in this.props)this.begin[b]=a[b];this.duration=Math.max(this.duration,1);if(!d.tweens.hasOwnProperty(this.tween))throw"Unrecognized tween in animate plugin: "+
this.tween;this.tweenfn=d.tweens[this.tween];this.epoch=d.getNow()};a.prototype.onSpriteRemoved=function(){};return function(c){d=c;d.registerSpriteUpdater("animate",a)}});
define("plugins/sprite/8way",[],function(){function a(){}var d;a.prototype.update=function(a,b){var e=this.sprite,d=e.directionx-e.x,f=2*(e.directiony-e.y);if(0===f)d=0===d?this.direction:0<d?"e":"w";else var h=d/f,d=0<=h?0.41421>h?0<f?"s":"n":2.4142<h?0<d?"e":"w":0<d?"se":"nw":-0.41421<h?0<f?"s":"n":-2.4142>h?0<d?"e":"w":0<d?"ne":"sw";this.direction=d;this.oldx=e.x;this.oldy=e.y;e.setState(e.stateName,this.direction);return!0};a.prototype.init=function(a){this.sprite=a;this.direction="e"};a.prototype.onSpriteRemoved=
function(){};return function(c){d=c;d.registerSpriteUpdater("8way",a)}});
define("plugins/sprite/track",[],function(){function a(){}var d;a.prototype.update=function(a,b){var e=this.sprite;if(e.x!==this.x||e.y!==this.y||e.h!==this.h)this.fn(e),this.x=e.x,this.y=e.y,this.h=e.h;return!0};a.prototype.onSpriteRemoved=function(){this.deregister&&this.deregister(this.sprite)};a.prototype.init=function(a){this.sprite=a;this.x=a.x;this.y=a.y;this.h=a.h;this.register&&this.register(a)};return function(c){d=c;d.registerSpriteUpdater("track",a)}});
define("plugins/sprite/flock",[],function(){function a(){this.xy=[0,0];this.xy2=[0,0]}var d;a.prototype.update=function(a,b){var e;e=void 0===this.lastTime?16:a-this.lastTime;this.lastTime=a;var d=0,f=0,h,k,q,m,p=this.sprite,n=this.tracker.find(p.x,p.y,this.flock_neighborhood,!0);this.flock_steering(p,this.xy);this.xy[0]*=0.5;this.xy[1]*=0.5;var r=Math.min(this.flock_neighbor_limit,n.length);if(0<r){for(h=r-1;0<=h;h--)m=n[h],d+=m.x,f+=m.y;p.vectorTo(d/r,f/r,this.xy2);this.xy[0]+=1.8*this.xy2[0];this.xy[1]+=
1.8*this.xy2[1]}if(0<r){f=d=0;for(h=r-1;0<=h;h--)p.vector(this.xy2),d+=this.xy2[0],f+=this.xy2[1];d/=r;f/=r;this.xy[0]+=1*d/r;this.xy[1]+=1*f/r}for(h=f=d=r=0;h<n.length;h++){m=n[h];k=p.x-m.x;q=p.y-m.y;k=k*k+(q+q);if(k>this.flock_separation2)break;r++;d+=m.x;f+=m.y}0<r&&(d/=r,f/=r,p.vectorTo(d,f,this.xy2),this.xy[0]-=2*this.xy2[0],this.xy[1]-=2*this.xy2[1]);p.velocityx=1.5*p.velocityx+this.xy[0];p.velocityy=0.75*p.velocityy+this.xy[1];e=this.flock_speed*e/1E3;d=p.velocityx*p.velocityx+p.velocityy*
p.velocityy;d>e*e&&(d=Math.sqrt(d),p.velocityx=e*p.velocityx/d,p.velocityy=e*p.velocityy/d);return!0};a.prototype.onSpriteRemoved=function(){};a.prototype.init=function(a){this.sprite=a;void 0===this.flock_speed&&(this.flock_speed=120);void 0===this.flock_neighborhood&&(this.flock_neighborhood=50);void 0===this.flock_separation&&(this.flock_separation=Math.min(20,this.flock_neighborhood/2));this.flock_separation2=this.flock_separation*this.flock_separation;void 0===this.flock_neighbor_limit&&(this.flock_neighbor_limit=
5)};return function(c){d=c;d.registerSpriteUpdater("flock",a)}});define("plugins/sprite/apply-velocity",[],function(){function a(){}var d;a.prototype.update=function(a,b){var d=this.sprite;d.move(d.velocityx,d.velocityy)&&void 0!==this.on_collision&&this.on_collision.call(d);return!0};a.prototype.init=function(a){this.sprite=a};a.prototype.onSpriteRemoved=function(){};return function(c){d=c;d.registerSpriteUpdater("apply-velocity",a)}});
define("plugins/layer/ui",[],function(){function a(a,b){this.opts=b||{};this.name=a}var d;a.prototype.update=function(a){};a.prototype.draw=function(a,b){};return function(c){d=c;d.registerLayerPlugin("ui",a)}});
define("plugins/layer/ground-sprites",["sprites/sprite","util/uid"],function(a,d){function c(b,a){this.opts=a||{};this.name=b;this.sprites=[];this.spriteMap={}}var b;c.prototype.update=function(b){};c.prototype.draw=function(a,c){for(var d=b.map,h=this.sprites.length-1;0<=h;h--)this.sprites[h].draw(a,d.xoffset,d.yoffset,c)};c.prototype.purgeAll=function(){for(var b=this.sprites.length-1;0<=b;b--)this.sprites[b].onRemove();this.sprites=[];this.spriteMap={}};c.prototype.spawnSprite=function(c,l,f,h,
k,q){q=q||{};if(void 0===q.id)q.id=d();else if(b.spriteMap.hasOwnProperty(q.id))throw"Error: duplicate sprite id "+q.id;c=a.construct(b,c,l,f,h,k,0,q);this.sprites.push(c);return this.spriteMap[q.id]=c};return function(a){b=a;b.registerLayerPlugin("ground-sprites",c)}});
define("plugins/fx/particles",["sprites/sprite","sprites/composite","util/rnd"],function(a,d,c){function b(b){this.opts=b;var a="number"===typeof b.number?b.number:b.number(),c="function"===typeof b.x?b.x():b.x,d="function"===typeof b.y?b.y():b.y;this.duration="function"===typeof b.duration?b.duration():b.duration;this.epoch=e.getNow();this.endCallback=b.endCallback;for(this.comp=e.createComposite(c,d,b.id);0<a--;)c=b.spritePos||{x:0,y:0,h:0},this.comp.addSprite(b.def,b.state,c.x||0,c.y||0,c.h||0,
b.spriteOpts).particleData={xspeed:l(-400,400)/1E3,hspeed:l(-600,50)/1E3,xaccell:0,haccell:0.001,startx:c.x||0,starth:c.h||0,epoch:this.epoch}}var e,l=c.rnd,f=function(b,a){var c=b.particleData,d=a-c.epoch,e=d*d;b.x=Math.floor(c.startx+(c.xspeed*d+c.xaccell*e/2));b.h=Math.floor(c.starth-(c.hspeed*d+c.haccell*e/2));0>b.h&&(b.h=0)};b.prototype.update=function(b){this.comp.update(b,f.bind(this));if(void 0!==this.duration&&b-this.epoch>this.duration)return void 0!==this.endCallback&&this.endCallback(),
!1;b=this.comp.isActive();!b&&void 0!==this.endCallback&&this.endCallback();return b};return function(a){e=a;e.registerFxPlugin("particles",b)}});
define("plugins/ai/phasers/time-phaser",[],function(){function a(a,b){this.id=a;b=b||{};if(void 0===b.updatesPerSecond||1>b.updatesPerSecond)throw"Time phasers must define a >0 number of updates per second.";this.updatesPerSecond=b.updatesPerSecond;this.updatesThisFrame=this.lastUpdate=0;this.sprites=[];this.frameCap=void 0===b.frameCap?750:Math.min(1E3,1E3*b.frameCap|0)}var d;a.prototype.phase=function(a,b){var d=a.phaserData[this.id];d.phaseOn&&(d.lastUpdate=b);return d.phaseOn};a.prototype.addSprite=
function(a){void 0===a.phaserData&&(a.phaserData={});a.phaserData[this.id]={lastUpdate:0};this.sprites.push(a)};a.prototype.removeSprite=function(a){delete a.phaserData[this.id]};a.prototype.rebalance=function(a){var b=Math.min(this.frameCap,a-this.lastUpdate);this.lastUpdate=a;var d=Math.floor(b*this.updatesPerSecond/1E3),l=this.id,f=this.sprites;f.sort(function(b,a){return a.phaserData[l].lastUpdate-b.phaserData[l].lastUpdate});var h=0;for(a=f.length-1;0<=a;a--)b=f[a],b.phaserData.hasOwnProperty(this.id)?
b.phaserData[this.id].phaseOn=0<d--:h++;if(0<h){f=[];d=this.sprites.length;for(a=0;a<d;a++)b=f[a],b.phaserData.hasOwnProperty(this.id)&&f.push(b);this.sprites=f}};return function(c){d=c;d.registerPhaserPlugin("time-phaser",a)}});
define("plugins/ai/phasers/frame-phaser",[],function(){function a(a,b){this.id=a;b=b||{};if(void 0===b.phases||2>b.phases)throw"Frame phasers must have at least 2 phases.";this.phases=b.phases;this.buckets=Array(b.phases);this.bucketMax=Array(b.phases);this.sprites=[]}var d;a.prototype.phase=function(a,b){return 0===a.phaserData[this.id].phase};a.prototype.addSprite=function(a){void 0===a.phaserData&&(a.phaserData={});a.phaserData[this.id]={phase:this.phases-1};this.sprites.push(a)};a.prototype.removeSprite=
function(a){delete a.phaserData[this.id]};a.prototype.rebalance=function(a){var b,d,l=0,f=this.buckets,h=this.sprites,k=h.length/this.phases;for(a=f.length-1;0<=a;a--)f[a]=0,this.bucketMax[a]=Math.floor((a+1)*k-Math.floor(a*k));var q=[],m=0;for(a=h.length-1;0<=a;a--)b=h[a],b.phaserData.hasOwnProperty(this.id)?(d=b.phaserData[this.id],d.phase++,d.phase>=this.phases&&(d.phase=0),l=Math.max(l,++f[d.phase]),f[d.phase]>this.bucketMax[d.phase]&&q.push(b)):m++;if(1<k&&0.8>k/l){h=0;for(a=q.length-1;0<=a;a--){for(b=
q[a];f[h]>=this.bucketMax[h];)h++,h===this.phases&&(h=0);d=b.phaserData[this.id];f[d.phase]--;d.phase=h;f[h]++}}if(0<m){h=[];d=this.sprites.length;for(a=0;a<d;a++)b.phaserData.hasOwnProperty(this.id)&&h.push(this.sprites[a]);this.sprites=h}};return function(c){d=c;d.registerPhaserPlugin("frame-phaser",a)}});
define("plugins/camera/push-cam",[],function(){function a(a){this.follow=d.sprite(a.follow);if(!this.follow)throw"Camera can't follow missing sprite: "+a.follow;}var d;a.prototype.update=function(a){d.scrollTo(this.follow.x-d.clientWidth/2,this.follow.y-d.clientHeight/2)};return function(c){d=c;d.registerCameraPlugin("pushcam",a)}});
define("plugins/collision/lib/prop-scanner",[],function(){return function(a,d,c,b,e,l,f,h,k,q){var m=b,p=e,n=l,r=f,s,u=b+l|0,v=e+f|0;b|=0;e|=0;l=Math.abs(u-b);f=Math.abs(v-e);var w=0;void 0!==q&&(q.length=0,q.length=2*(Math.max(l,f)+1));if(0===l&&0===f)return k[0]=b,k[1]=e,1;var y=b<u?1:-1,x=e<v?1:-1,t=l-f,z=!1,g=b,A=e;void 0!==q&&(q[w++]=b,q[w++]=e);s=2*t;s>-f&&(t-=f,b+=y);s<l&&(t+=l,e+=x);for(;;){if(b<c.le||b>c.re||e<c.te||e>c.be){z=!0;break}s=a.getTilePropAtWorldPos(d,b,e);if(s>h){z=!0;break}g=
b;A=e;void 0!==q&&(q[w++]=b,q[w++]=e);if(b===u&&e===v)break;s=2*t;s>-f&&(t-=f,b+=y);s<l&&(t+=l,e+=x)}z?void 0!==k&&(k[0]=g,k[1]=A):void 0!==k&&(k[0]=m+n,k[1]=p+r);void 0!==q&&(q.length=w);return!z?1:l>f?(k[0]-m)/n:(k[1]-p)/r}});
define("plugins/collision/lib/local-scanner",[],function(){return{ySlip:function(a,d,c,b,e,l){e/=l;if(2<=e&&3>=e){if(a.getTilePropAtWorldPos("height",d+1,c-1)>b&&a.getTilePropAtWorldPos("height",d,c-1)>b&&a.getTilePropAtWorldPos("height",d+1,c)>b)return 1;if(a.getTilePropAtWorldPos("height",d-1,c+1)>b&&a.getTilePropAtWorldPos("height",d-1,c)>b&&a.getTilePropAtWorldPos("height",d,c+1)>b)return-1}else if(-2>=e&&-3<=e){if(a.getTilePropAtWorldPos("height",d+1,c+1)>b&&a.getTilePropAtWorldPos("height",
d,c+1)>b&&a.getTilePropAtWorldPos("height",d+1,c)>b)return-1;if(a.getTilePropAtWorldPos("height",d-1,c-1)>b&&a.getTilePropAtWorldPos("height",d-1,c)>b&&a.getTilePropAtWorldPos("height",d,c-1)>b)return 1}return 0}}});
define("plugins/collision/sprite-with-map/line-trace",["plugins/collision/lib/prop-scanner","plugins/collision/lib/local-scanner"],function(a,d){function c(a){a=a||{};this.sn=b;this.edges=b.getWorldEdges();this.xy=[0,0];this.autoSlip=void 0===a.autoSlip?!0:a.autoSlip}var b,e=d.ySlip;c.prototype.test=function(c,d,h,k,q,m){var p=b.worldToTilePos(c,d,this.xy);if(h*h+k*k<=p*p)return m[0]=c+h,m[1]=d+k,1;this.autoSlip&&(d+=e(b,c,d,q,h,k));return a(b,"height",this.edges,c,d,h,k,q,m)};return function(a){b=
a;b.registerColliderPlugin("line-trace",c)}});define("plugins/collision/lib/ellipse",[],function(){return function(a,d){var c=a*a,b=d*d,e=2*c,l=2*b,f,h=0,k=d,q=0,m=e*k,p=[];p.push(h,k,-h,k,h,-k,-h,-k);for(f=Math.round(b-c*d+0.25*c);q<m;)h++,q+=l,0>f?f+=b+q:(k--,m-=e,f+=b+q-m),p.push(h,k,-h,k,h,-k,-h,-k);for(f=Math.round(b*(h+0.5)*(h+0.5)+c*(k-1)*(k-1)-c*b);0<k;)k--,m-=e,0<f?f+=c-m:(h++,q+=l,f+=c-m+q),p.push(h,k,-h,k,h,-k,-h,-k);return p}});
define("plugins/collision/sprite-with-map/circle-trace",["plugins/collision/lib/prop-scanner","plugins/collision/lib/ellipse","plugins/collision/lib/local-scanner"],function(a,d,c){function b(a){a=a||{};this.sn=e;if(void 0===a.radius||0===a.radius)throw"Circle trace requires a radius >0 in its options.";this.radius=a.radius;this.edges=e.getWorldEdges();this.samples=d(a.radius|0,a.radius/2|0);this.lineHit=[0,0];this.autoSlip=void 0===a.autoSlip?!0:a.autoSlip}var e,l=c.ySlip;b.prototype.test=function(b,
c,d,q,m,p){var n,r,s;s=e.worldToTilePos(b,c,this.lineHit);n=Math.abs(d)+this.radius;r=Math.abs(q/2)+this.radius/2;if(n*n+r*r<=s*s)return p[0]=b+d,p[1]=c+q,1;if(this.autoSlip){var u=0;for(s=this.samples.length-2;0<=s;s-=2)if(n=this.samples[s],r=this.samples[s+1],n=l(e,b+n,c+r,m,d,q),0===u)u=n;else if(0!==n&&u!==n){u=0;break}c+=u}var u=[],v=a(e,"height",this.edges,b,c,d,q,m,this.lineHit,u),w,y,x=!0;for(s=u.length-2;2<=s&&x;s-=2){for(var x=!1,t=this.samples.length-2;0<=t;t-=2)if(n=this.samples[t],r=
this.samples[t+1],w=u[s],y=u[s+1],e.getTilePropAtWorldPos("height",w+n,y+r)>m){x=!0;break}if(!x){if(s===u.length-2)return p[0]=this.lineHit[0],p[1]=this.lineHit[1],v;p[0]=w;p[1]=y;return d>q?(w-b)/d:(y-c)/q}}p[0]=b;p[1]=c;return 0};return function(a){e=a;e.registerColliderPlugin("circle-trace",b)}});
define("plugins/default-plugins","plugins/sprite/bounce plugins/sprite/follow-mouse plugins/sprite/animate plugins/sprite/8way plugins/sprite/track plugins/sprite/flock plugins/sprite/apply-velocity plugins/layer/ui plugins/layer/ground-sprites plugins/fx/particles plugins/ai/phasers/time-phaser plugins/ai/phasers/frame-phaser plugins/camera/push-cam plugins/collision/sprite-with-map/line-trace plugins/collision/sprite-with-map/circle-trace".split(" "),function(){var a=arguments;return function(d){for(var c=
0;c<a.length;c++)a[c](d)}});define("tasks/slowqueue",["util/minheap","util/uid"],function(a,d){function c(b){this.queue=new a;this.maxFrameTime=b;this.id=d()}c.prototype.addTask=function(a,c){this.queue.push({task:a,priority:void 0===c?1:c})};c.prototype.run=function(){};return c});
define("animate/tween",[],function(){return{linear:function(a,d,c,b){return d+c*Math.min(1,a/b)},easeInOutCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-2*b*a+3*b)},easeInOutQuintic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;a*=b;return d+c*(6*a*b+-15*b*b+10*a)},easeInQuintic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*b*a*b},easeInQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*b*b},easeInCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a*a;return d+
c*b},easeInQuadratic:function(a,d,c,b){a=Math.min(b,a);return d+c*(a*a/b)},easeOutQuintic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;var e=b*a;return d+c*(e*b+-5*b*b+10*e+-10*b+5*a)},easeOutQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-1*b*b+4*b*a+-6*b+4*a)},easeOutCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(b*a+-3*b+3*a)},easeOutInCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(4*b*a+-6*b+3*a)},backInCubic:function(a,d,c,b){a=Math.min(b,a);
b=(a/=b)*a;return d+c*(4*b*a+-3*b)},backInQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(2*b*b+2*b*a+-3*b)},outBackCubic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(4*b*a+-9*b+6*a)},outBackQuartic:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;return d+c*(-2*b*b+10*b*a+-15*b+8*a)},bounceOut:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;var e=b*a;return d+c*(33*e*b+-106*b*b+126*e+-67*b+15*a)},bounceIn:function(a,d,c,b){a=Math.min(b,a);b=(a/=b)*a;a*=b;return d+c*(33*a*b+
-59*b*b+32*a+-5*b)}}});
define("ai/proximity-tracker",[],function(){function a(a,c){if(2>c||0!==(c&1)||c!==c|0)throw"Cell size must be an even integer > 0";this.cellw=c;this.cellh=c/2;this.sn=a;var d=a.getWorldEdges();this.le=d.le;this.re=d.re;this.te=d.te;this.be=d.be;var d=this.be-this.te,f=this.re-this.le;this.span=f;d=Math.ceil(d/this.cellh);f=Math.ceil(f/this.cellw);this.cells=Array(d*f);this.id=a.util.uid();this.candidateCache={}}var d=function(a){var c=a.proximityData[this.id];void 0!==c.cell&&(c=this.cells[c.cell],
a=c.sprites.indexOf(a),0<=a&&c.sprites.splice(a,1))},c=function(a){a=Math.ceil(a/this.cellw);if(this.candidateCache.hasOwnProperty(a))a=this.candidateCache[a],this.certains=a.certains,this.uncertains=a.uncertains;else{if(1===a){this.certains=[];var c=this.span;this.uncertains=[-c-1,-c,-c+1,-1,0,1,c-1,c,c+1]}else{this.certains=[];this.uncertains=[];for(c=-a-1;c<=a+1;c++)for(var d=-a-1;d<=a+1;d++){var f=c+(0<c?1:-1),h=d+(0<d?1:-1);f*f+h*h<a*a?this.certains.push(d*this.span+c):(f=c-(0<c?1:-1),h=d-(0<
d?1:-1),f*f+h*h<a*a&&this.uncertains.push(d*this.span+c))}}this.candidateCache[a]={certains:this.certains,uncertains:this.uncertains}}};a.prototype.find=function(a,d,l,f){c.call(this,l);var h,k,q,m,p,n,r=[],s=(d/this.cellh|0)*this.span+(a/this.cellw|0);for(h=this.certains.length-1;0<=h;h--)if(k=s+this.certains[h],0<=k&&k<this.cells.length&&(q=this.cells[k],void 0!==q)){if(!0===f)for(k=q.sprites.length-1;0<=k;k--)m=q.sprites[k],p=a-m.x,n=2*(d-m.y),m.tmpDist2=p*p+n*n;r=r.concat(q.sprites)}l*=l;for(h=
this.uncertains.length-1;0<=h;h--)if(k=s+this.uncertains[h],0<=k&&k<this.cells.length&&(q=this.cells[k],void 0!==q))for(k=q.sprites.length-1;0<=k;k--)m=q.sprites[k],p=a-m.x,n=2*(d-m.y),m.tmpDist2=p*p+n*n,m.tmpDist2<=l&&r.push(m);!0===f&&r.sort(function(a,b){return a.tmpDist2-b.tmpDist2});return r};a.prototype.track=function(a){var c=a.proximityData[this.id],l=(a.y/this.cellh|0)*this.span+(a.x/this.cellw|0);l!==c.cell&&(d.call(this,a),void 0===this.cells[l]?this.cells[l]={sprites:[a]}:this.cells[l].sprites.push(a),
c.cell=l)};a.prototype.register=function(a){var c=(a.y/this.cellh|0)*this.span+(a.x/this.cellw|0);void 0===this.cells[c]?this.cells[c]={sprites:[a]}:this.cells[c].sprites.push(a);a.proximityData={};a.proximityData[this.id]={cell:c};this.track(a)};a.prototype.unregister=function(a){d.call(this,a);delete a.proximityData[this.id]};return a});
define("ai/pathfinder",[],function(){function a(a,b){this.x=a;this.y=b;this.priority=0}function d(b,c,d,e,f){this.sn=b;var l=b.map;this.ground=l.groundLayer();this.xcount=l.data.width;this.ycount=l.data.height;this.nodeRows=Array(this.ycount);void 0===e&&(e=!0);void 0===d&&(d=!0);for(var r=this.nodeRows.length-1;0<=r;r--)this.nodeRows[r]=Array(this.xcount);c=c||function(a,c){return 0<b.getTilePropAtTilePos("height",a,c)};r=Math.sqrt(2);this.cost=f||function(a,b){return 1};if(l.isStaggered())this.xdirectionsOdd=
d?[1,1,0,0,-1,0,0,1]:[1,0,-1,0],this.ydirectionsOdd=d?[0,1,2,1,0,-1,-2,-1]:[0,2,0,-2],this.xdirectionsEven=d?[1,0,0,-1,-1,-1,0,0]:[1,0,-1,0],this.ydirectionsEven=d?[0,1,2,1,0,-1,-2,-1]:[0,2,0,-2],this.distances=d?[r,1,r,1,r,1,r,1]:[1,1,1,-1],this.distance=e?function(a){return this.distances[a]}:function(a,b,d){var e=0===(d&1),h=e?this.xdirectionsEven:this.xdirectionsOdd,e=e?this.ydirectionsEven:this.ydirectionsOdd;switch(a){case 0:return c(b+h[7],d+e[7])||c(b+h[1],d+e[1])?3:this.distances[a];case 2:return c(b+
h[3],d+e[3])||c(b+h[1],d+e[1])?3:this.distances[a];case 4:return c(b+h[3],d+e[3])||c(b+h[5],d+e[5])?3:this.distances[a];case 6:return c(b+h[7],d+e[7])||c(b+h[5],d+e[5])?3:this.distances[a];default:return this.distances[a]}},this.ndirections=this.xdirectionsOdd.length;else if(l.isOrthogonal()){this.xdirectionsOdd=d?[1,1,0,-1,-1,-1,0,1]:[1,0,-1,0];this.ydirectionsOdd=d?[0,1,1,1,0,-1,-1,-1]:[0,1,0,-1];this.xdirectionsEven=this.xdirectionsOdd;this.ydirectionsEven=this.ydirectionsOdd;this.distances=d?
[1,r,1,r,1,r,1,r]:[1,1,1,-1];if(e)this.distance=function(a){return this.distances[a]};else throw"Unsupported cutcorners===false in map of type: "+l.type;this.ndirections=this.xdirectionsOdd.length}else throw"Unsupported map orientation in PathFinder: "+l.type;this.scoreHeap=new b.MinHeap;this.node=function(b,d){if(0>b||(b>=this.xcount||0>d||d>=this.ycount)||c(b,d))return null;var e;0===this.nodeRows[d].length&&(this.nodeRows[d].length=this.xcount);if(void 0===this.nodeRows[d][b])e=new a(b,d),this.nodeRows[d][b]=
e;else return this.nodeRows[d][b];return e};this.reconstructPath=function(a){for(var b=[];a.cameFrom;)b.push(a.x,a.y),a=a.cameFrom;b.push(this.startx,this.starty);return b}}var c=[0,1,1,1,0,0,-1,0],b=[-2,-1,0,1,2,1,0,-1],e=[0,0,1,0,0,-1,-1,-1],l=[-2,-1,0,1,2,1,0,-1],f=function(a,d,f,m){if(2>=a.length)return[];var p=this.sn.map,n=Array(a.length/2-1),r=[],s;if(m=!!m){var u=-1;for(s=a.length-2;0<=s;s-=2);}var v=function(g,p,m,n,s){var t,B,F,C;if(-1!==u){p=0===(s&1);switch(u){case 0:p?(p=e[5],m=l[5],
t=e[3],B=l[3]):(p=c[5],m=b[5],t=c[3],B=b[3]);break;case 2:p?(p=e[7],m=l[7],t=e[5],B=l[5]):(p=c[7],m=b[7],t=c[5],B=b[5]);break;case 4:p?(p=e[1],m=l[1],t=e[7],B=l[7]):(p=c[1],m=b[1],t=c[7],B=b[7]);break;case 6:p?(p=e[3],m=l[3],t=e[1],B=l[1]):(p=c[3],m=b[3],t=c[1],B=b[1]);break;default:u=g;return}if(u===g)a.push(n+p,s+m),r.push.apply(r,d.slice(g*f,(g+1)*f)),a.push(n+t,s+B),r.push.apply(r,d.slice(g*f,(g+1)*f));else{switch(u){case 0:F=1;C=7;break;case 2:F=3;C=1;break;case 4:F=5;C=3;break;case 6:F=7,C=
5}a.push(n+p,s+m);r.push.apply(r,d.slice(F*f,(F+1)*f));a.push(n+t,s+B);r.push.apply(r,d.slice(C*f,(C+1)*f))}}u=g};if(p.isStaggered())for(s=a.length-4;0<=s;s-=2){var p=a[s],w=a[s+1],y=a[s+2],x=a[s+3],t=p-y,z=[f*s/2,f];switch(w-x){case -2:m&&v(0,p,w,y,x);n.splice.apply(n,z.concat(d.slice(0,f)));break;case -1:0===t!==(0!==(w&1))?(m&&v(7,p,w,y,x),n.splice.apply(n,z.concat(d.slice(7*f,8*f)))):(m&&v(1,p,w,y,x),n.splice.apply(n,z.concat(d.slice(1*f,2*f))));break;case 0:1===t?(m&&v(2,p,w,y,x),n.splice.apply(n,
z.concat(d.slice(2*f,3*f)))):(m&&v(6,p,w,y,x),n.splice.apply(n,z.concat(d.slice(6*f,7*f))));break;case 1:0===t!==(0!==(w&1))?(m&&v(5,p,w,y,x),n.splice.apply(n,z.concat(d.slice(5*f,6*f)))):(m&&v(3,p,w,y,x),n.splice.apply(n,z.concat(d.slice(3*f,4*f))));break;default:m&&v(4,p,w,y,x),n.splice.apply(n,z.concat(d.slice(4*f,5*f)))}}else throw"Unsupported map orientation in routeToDirections/routeToVectors: "+p.type;0<r.length&&n.push.apply(n,r);return n};d.prototype.routeToVectors=function(a,b){return f.call(this,
a,[0,-1,1,-1,1,0,1,1,0,1,-1,1,-1,0,-1,-1],2,b)};d.prototype.routeToDirections=function(a,b){return f.call(this,a,"n ne e se s sw w nw".split(" "),1,b)};d.prototype.route=function(a,b,c,d){var e;this.startx=a;this.starty=b;for(e=this.nodeRows.length-1;0<=e;e--)this.nodeRows[e].length=0;e=this.node(a,b);e.open=!0;this.scoreHeap.clear().push(e);a=c-a;b=d-b;for(e.fscore=a*a+b*b;0<this.scoreHeap.size();){b=this.scoreHeap.peek();if(b.x===c&&b.y===d)return this.reconstructPath(b);this.scoreHeap.pop();b.closed=
!0;for(e=this.ndirections-1;0<=e;e--)if(a=0===(b.y&1),a=this.node(b.x+(a?this.xdirectionsEven[e]:this.xdirectionsOdd[e]),b.y+(a?this.ydirectionsEven[e]:this.ydirectionsOdd[e])),null!==a){var f=b.priority+this.cost(b.x,b.y)*this.distance(e,b.x,b.y);if(!(a.closed&&f>=a.priority)&&(!a.open||f<a.priority)){a.cameFrom=b;a.priority=f;var f=c-a.x,l=d-a.y;a.fscore=a.gscore+(f*f+l*l);a.open||(a.open=!0,this.scoreHeap.push(a))}}}return[]};return d});
define("polyfills/requestAnimationFrame",[],function(){for(var a=0,d=["ms","moz","webkit","o"],c=0;c<d.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[d[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[d[c]+"CancelAnimationFrame"]||window[d[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),f=Math.max(0,16-(d-a)),h=window.setTimeout(function(){b(d+f)},f);a=d+f;return h});
window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})});
define("polyfills/bind",[],function(){Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var d=Array.prototype.slice.call(arguments,1),c=this,b=function(){},e=function(){return c.apply(this instanceof b&&a?this:a,d.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;e.prototype=new b;return e})});
define("snaps","sprites/spritedef sprites/sprite sprites/composite input/keyboard input/mouse util/all map/staggered-isometric plugins/default-plugins tasks/slowqueue animate/tween ai/proximity-tracker ai/pathfinder polyfills/requestAnimationFrame polyfills/bind".split(" "),function(a,d,c,b,e,l,f,h,k,q,m,p){function n(n,x,t){function z(a){315532800<a&&0===g.epoch&&(g.epoch=a-16);a-=g.epoch;g.now=a;g.requestAnimationFrame(z);g.updateTasks();g.updateFX();g.map.updateLayers(a);g.updatePhasers();E(a-
g.lastFrameTime);g.updateSprites();g.camera&&g.camera.update(a);D(g.ctx);g.dbgShowRegions&&void 0!==g.map&&g.map.drawDebugRegions(g.ctx);g.dbgShowMouse&&(r(g.ctx,"Screen: "+g.mouse.x+","+g.mouse.y,5,15),r(g.ctx,"World: "+(g.mouse.x+g.map.xoffset)+","+(g.mouse.y+g.map.yoffset),5,30),r(g.ctx,"Origin: "+g.map.xoffset+","+g.map.yoffset,5,45));g.dbgShowCounts&&r(g.ctx,"Sprites: "+g.spriteCount(),5,g.clientHeight-15);if(g.dbgShowMouseTile&&void 0!==g.map){a=[0,0];g.mouseWorldPos(a);var b=[0,0];g.worldToTilePos(a[0],
a[1],b);r(g.ctx,"Mouse in tile: "+b[0]+", "+b[1],5,g.clientHeight-30)}g.lastFrameTime=g.now}var g=this;this.requestAnimationFrame=window.requestAnimationFrame.bind(window);this.util=l;this.tweens=q;this.MinHeap=u;this.Stats=w;this.ProximityTracker=m.bind(m,this);this.PathFinder=p.bind(p,this);t=t||{};this.dbgShowMouse=!!t.showMouse;this.dbgShowCounts=!!t.showCounts;this.dbgShowRegions=!!t.showRegions;this.dbgShowMouseTile=!!t.showMouseTile;this.imageCache={};this.spriteUpdaters={};this.colliders=
{};this.fxUpdaters={};this.layerPlugins={};this.cameraPlugins={};this.phaserPlugins={};this.stats=new w;this.timers={};this.cameras={};this.camera=null;this.activeFX=[];this.taskQueues=[];this.epoch=this.now=0;var A=document.getElementById(x);this.clientWidth=A.clientWidth;this.clientHeight=A.clientHeight;this.ctx=A.getContext("2d");this.keyboard=new b;this.mouse=new e(A);this.ctx.fillStyle="#000022";this.ctx.fillRect(0,0,A.clientWidth,A.clientHeight);this.game=n;if(void 0!==n.map){if("object"!==
typeof n.hitTests||void 0===n.hitTests.hit)throw"Game must define a hitTests object with at least a 'hit' property";this.map=new f(n.map,n.hitTests,this.clientWidth,this.clientHeight,this.stats);this.map.hideBuildings=!!t.hideBuildings}var D=g.game.draw,E=g.game.update;this.spriteDefs={};this.sprites=[];this.phasers=[];this.spriteMap={};this.lastFrameTime=0;this.registerSpriteUpdater=function(a,b){g.spriteUpdaters[a]=b};this.registerFxPlugin=function(a,b){g.fxUpdaters[a]=b};this.registerLayerPlugin=
function(a,b){g.layerPlugins[a]=b};this.registerColliderPlugin=function(a,b){g.colliders[a]=b};this.registerCameraPlugin=function(a,b){g.cameraPlugins[a]=b};this.registerPhaserPlugin=function(a,b){g.phaserPlugins[a]=b};h(this);if("function"===typeof g.game.onEngineStart)g.game.onEngineStart(this);t=new s;void 0!==this.map&&this.map.primePreloader(t);if("object"===typeof n.preloadImages){var A=function(a,b){g.imageCache[b]=a},G;for(G in n.preloadImages)t.add(n.preloadImages[G],G,A)}if("object"===typeof g.game.spriteDefs){n=
function(b,c){var d,e=g.game.spriteDefs[c],f=new a(b,e.w,e.h,e.x,e.y);g.spriteDefs[c]=f;for(d in e.states)"object"===typeof e.states[d]&&f.addState(d,e.states[d].seq,e.states[d].dur),"number"===typeof e.states[d]&&f.addState(d,[e.states[d]],1E3);for(d in e.states)"string"===typeof e.states[d]&&f.aliasState(d,e.states[d])};for(var H in g.game.spriteDefs)t.add(g.game.spriteDefs[H].path,H,n)}this.drawImage=function(a,b,c){g.ctx.drawImage(g.imageCache[a],b,c)};this.cls=function(a){g.ctx.fillStyle=a||
"#000";g.ctx.fillRect(0,0,g.clientWidth,g.clientHeight)};this.bindKeys=function(a){for(var b=0;b<a.length;b++){var c=a[b];g.keyboard.bind(c.key,c.action)}};this.updateTasks=function(){for(var a=+new Date,b=g.taskQueues.length-1;0<=b;b--)g.taskQueues[b].run();this.stats.count("updateTasks",+new Date-a)};this.updatePhasers=function(){for(var a=+new Date,b=g.phasers.length-1;0<=b;b--)g.phasers[b].rebalance(g.now);this.stats.count("updatePhasers",+new Date-a)};this.updateFX=function(){for(var a=+new Date,
b=g.activeFX.length-1;0<=b;b--)g.activeFX[b].update(g.now)||g.activeFX.splice(b,1);this.stats.count("updateFX",+new Date-a)};this.fx=function(a,b){if(!g.fxUpdaters.hasOwnProperty(a))throw"Can't create FX for unregistered FX type: "+a;g.activeFX.push(new g.fxUpdaters[a](b))};this.addLayer=function(a,b,c,d){c=c||{};if(!g.layerPlugins.hasOwnProperty(b))throw"Can't create layer for unregistered layer type: "+b;a=new g.layerPlugins[b](a,c);g.map.insertLayer(d,a);return a};this.spriteCount=function(){for(var a=
0,b=0;b<g.sprites.length;b++){var d=g.sprites[b];d instanceof c?a+=d.sprites.length:a++}return a};t.load(function(){void 0!==g.map&&g.map.resolveTiles();if("function"===typeof g.game.onResourcesLoaded)g.game.onResourcesLoaded();setTimeout(function(){z(0)},0)},function(a){if("function"===typeof g.game.onProgress)g.game.onProgress(a,g.ctx)},function(){if("function"===typeof g.game.onLoadError)g.game.onLoadError()});this.actioning=function(a){return g.keyboard.actionPressed(a)};this.scroll=function(a,
b){g.map.scroll(a,b)};this.scrollTo=function(a,b){g.map.scrollTo(a,b)};this.getWorldEdges=function(){return g.map.getWorldEdges()};this.drawWorld=function(){this.map.drawWorld(g.ctx,g.now,g.sprites)};this.mouseScreenPos=function(a){a[0]=g.mouse.x;a[1]=g.mouse.y};this.mouseWorldPos=function(a){g.map.screenToWorldPos(g.mouse.x,g.mouse.y,a)};this.worldToTilePos=function(a,b,c){return this.map.worldToTilePos(a,b,c)};this.screenToTilePos=function(a,b,c){return this.map.screenToTilePos(a,b,c)};this.screenToWorldPos=
function(a,b,c){this.map.screenToWorldPos(a,b,c)};this.worldToScreenPos=function(a,b,c){this.map.worldToScreenPos(a,b,c)};this.getTile=function(a,b,c){return this.map.getTile(a,b,c)};this.getTileWorldPos=function(a,b,c){this.map.tileDimensions(c);c[0]=0===(b&1)?(a+1)*c[0]-c[0]/2:(a+1)*c[0];c[1]=(b+1)*(c[1]/2)};this.getTilePropAtWorldPos=function(a,b,c){return this.map.getTilePropAtWorldPos(a,b,c)};this.getTilePropAtTilePos=function(a,b,c){return this.map.getTilePropAtTilePos(a,b,c)};this.createCollider=
function(a,b){if(!g.colliders.hasOwnProperty(a))throw"Warning: undefined collider plugin: "+a;return new g.colliders[a](b)};this.createTaskQueue=function(a){a=new k(a);this.taskQueues.push(a);return a};this.createCamera=function(a,b,c){if(!g.cameraPlugins.hasOwnProperty(b))throw"Warning: undefined camera plugin: "+b;if(this.cameras.hasOwnProperty(a))throw"Camera already exists: "+a;this.cameras[a]=new g.cameraPlugins[b](c);return this.cameras[a]};this.switchToCamera=function(a){this.camera=this.cameras[a]};
this.spawnSprite=function(a,b,c,e,f,h,k){k=k||{};if(void 0===k.id)k.id=v();else if(g.spriteMap.hasOwnProperty(k.id))throw"Error: duplicate sprite id "+k.id;a=d.construct(g,a,b,c,e,f,h,k);g.sprites.push(a);return g.spriteMap[k.id]=a};this.createComposite=function(a,b,d,e){if(void 0===d)d="id"+v();else if(g.spriteMap.hasOwnProperty(d))throw"Warning: duplicate sprite (composite) id "+d;a=new c(this,a,b,d,e);a.init();g.sprites.push(a);return g.spriteMap[d]=a};this.markTime=function(a,b){g.timers[a]=g.now+
b};this.checkTimer=function(a,b){if(void 0===g.timers[a])return!1;var c=g.timers[a];if(0<g.now-c){if(void 0===b)delete g.timers[a];else{b=Math.max(1,b);do c+=b;while(c<g.now);g.timers[a]=c}return!0}return!1};this.sprite=function(a){return g.spriteMap[a]};this.updateSprites=function(){var a=+new Date,b=[],c,d;for(c=0;c<g.sprites.length;c++)d=g.sprites[c],d.isActive(g.now)?(d.update(g.now),b.push(d)):(d.onRemove(),delete g.spriteMap[d.name]);g.sprites=b;for(c=0;c<g.sprites.length;c++)d=g.sprites[c],
d.commit(g.now);this.stats.count("updateSprites",+new Date-a)};this.getNow=function(){return g.now};this.createPhaser=function(a,b){if(!g.phaserPlugins.hasOwnProperty(a))throw"Can't create phaser for unregistered type: "+a;var c=new g.phaserPlugins[a]("id"+v(),b);g.phasers.push(c);return c};this.resizeCanvas=function(){var a=document.getElementById(x);this.clientWidth=a.clientWidth;this.clientHeight=a.clientHeight;g.map.onResize(a.clientWidth,a.clientHeight)}}var r=l.debug.debugText,s=l.Preloader,
u=l.MinHeap,v=l.uid,w=l.Stats;n.util=l;return n});
